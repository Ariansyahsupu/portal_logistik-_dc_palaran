import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from "firebase/app";
import { getAuth, signInAnonymously, onAuthStateChanged } from "firebase/auth";
import { getFirestore, collection, addDoc, serverTimestamp } from "firebase/firestore";
import { 
  Truck, 
  Package, 
  BarChart3, 
  Settings, 
  ShieldCheck, 
  ArrowRight, 
  Menu, 
  X, 
  Anchor, 
  Database, 
  TrendingUp, 
  Layers, 
  Cpu, 
  Box, 
  Phone, 
  Mail, 
  MapPin, 
  Loader2, 
  Search, 
  CheckCircle, 
  Clock, 
  ClipboardList, 
  ExternalLink, 
  AlertCircle, 
  DollarSign, 
  Activity, 
  ArrowLeft, 
  LayoutDashboard, 
  FileText, 
  Send, 
  Download, 
  AlertTriangle, 
  Trash2,
  GitMerge,
  PieChart
} from 'lucide-react';

// --- Firebase Initialization ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// --- SHARED UTILS ---
const formatIDR = (value) => {
  return new Intl.NumberFormat('id-ID', {
    style: 'currency',
    currency: 'IDR',
    minimumFractionDigits: 0,
    maximumFractionDigits: 0,
  }).format(value);
};

const normalizeString = (str) => {
    if (!str) return "";
    return String(str).toUpperCase().replace(/[^A-Z0-9]/g, '');
};

// Utility to load XLSX library dynamically
const loadXLSX = () => {
  return new Promise((resolve, reject) => {
    if (window.XLSX) {
      resolve(window.XLSX);
      return;
    }
    const script = document.createElement('script');
    script.src = "https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js";
    script.onload = () => resolve(window.XLSX);
    script.onerror = reject;
    document.head.appendChild(script);
  });
};

// --- COMPONENTS ---

const Navbar = ({ isScrolled, onNavigate, activeView }) => {
  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
  
  const handleNavClick = (view, sectionId) => {
    onNavigate(view);
    setIsMobileMenuOpen(false);
    if (sectionId) {
      setTimeout(() => {
        const element = document.getElementById(sectionId);
        if (element) element.scrollIntoView({ behavior: 'smooth' });
      }, 100);
    } else {
      window.scrollTo(0,0);
    }
  };

  return (
    <nav className={`fixed w-full z-50 transition-all duration-300 ${isScrolled ? 'bg-slate-900 shadow-lg py-3' : 'bg-transparent py-5'}`}>
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div className="flex justify-between items-center">
          <div className="flex items-center space-x-2 cursor-pointer" onClick={() => handleNavClick('home')}>
            <div className="bg-orange-500 p-2 rounded-lg">
              <Anchor className="h-6 w-6 text-white" />
            </div>
            <div className="flex flex-col">
              <span className="text-xl font-bold tracking-tighter text-white">DC PALARAN</span>
              <span className="text-xs text-orange-400 font-medium tracking-widest uppercase">Mining Logistics Hub</span>
            </div>
          </div>
          <div className="hidden lg:flex items-center space-x-6">
            <button onClick={() => handleNavClick('home', 'home')} className="text-slate-200 hover:text-orange-500 font-medium text-sm uppercase">Home</button>
            <button onClick={() => handleNavClick('analysis')} className="text-slate-200 hover:text-orange-500 font-medium text-sm uppercase">Analysis Tools</button>
            <button onClick={() => handleNavClick('home', 'functions')} className="text-slate-200 hover:text-orange-500 font-medium text-sm uppercase">Functions</button>
            <button onClick={() => handleNavClick('home', 'process')} className="text-slate-200 hover:text-orange-500 font-medium text-sm uppercase">Process</button>
            <button onClick={() => handleNavClick('home', 'tracking')} className="text-slate-200 hover:text-orange-500 font-medium text-sm uppercase">Tracking</button>
            <button onClick={() => handleNavClick('catalog')} className="text-slate-200 hover:text-orange-500 font-medium text-sm uppercase flex items-center">
              <FileText className="w-4 h-4 mr-1" /> Catalog
            </button>
            <button onClick={() => handleNavClick('dashboard')} className={`text-sm uppercase font-medium flex items-center ${activeView === 'dashboard' ? 'text-orange-500' : 'text-slate-200 hover:text-orange-500'}`}>
              <LayoutDashboard className="w-4 h-4 mr-1" /> Dashboard
            </button>
            <button onClick={() => handleNavClick('home', 'contact')} className="bg-orange-500 hover:bg-orange-600 text-white px-5 py-2 rounded-sm font-bold transition-all text-sm uppercase">
              Check Stock
            </button>
          </div>
          <div className="lg:hidden">
            <button onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)} className="text-white">
              <Menu className="h-8 w-8" />
            </button>
          </div>
        </div>
      </div>
      
      {/* Mobile Menu */}
      {isMobileMenuOpen && (
        <div className="lg:hidden bg-slate-900 border-t border-slate-800 p-4 space-y-2">
           <button onClick={() => handleNavClick('home', 'home')} className="block w-full text-left text-slate-300 py-2">Home</button>
           <button onClick={() => handleNavClick('analysis')} className="block w-full text-left text-slate-300 py-2">Analysis Tools</button>
           <button onClick={() => handleNavClick('catalog')} className="block w-full text-left text-slate-300 py-2">Catalog</button>
           <button onClick={() => handleNavClick('dashboard')} className="block w-full text-left text-slate-300 py-2">Dashboard</button>
        </div>
      )}
    </nav>
  );
};

// --- SECTIONS ---

const Hero = () => (
  <div id="home" className="relative h-screen flex items-center justify-center overflow-hidden bg-slate-900">
    <div className="absolute inset-0 z-0">
      <img src="https://images.unsplash.com/photo-1586528116311-ad8dd3c8310d?lib=rb-4.0.3&auto=format&fit=crop&w=2070&q=80" className="w-full h-full object-cover opacity-40" alt="Logistics" />
      <div className="absolute inset-0 bg-gradient-to-r from-slate-900 via-slate-900/80 to-transparent"></div>
    </div>
    <div className="relative z-10 max-w-7xl mx-auto px-4 flex flex-col justify-center h-full">
      <div className="max-w-3xl">
        <div className="inline-flex items-center space-x-2 bg-orange-500/10 border border-orange-500/30 rounded-full px-4 py-1 mb-6 backdrop-blur-sm">
          <span className="flex h-2 w-2 rounded-full bg-orange-500 animate-pulse"></span>
          <span className="text-orange-400 text-sm font-semibold tracking-wide uppercase">Operational Efficiency Optimized</span>
        </div>
        <h1 className="text-5xl md:text-7xl font-extrabold text-white leading-tight mb-6">
          The Central Nerve of <br/><span className="text-transparent bg-clip-text bg-gradient-to-r from-orange-400 to-orange-600">Mining Logistics</span>
        </h1>
        <p className="text-xl text-slate-300 mb-8 max-w-2xl leading-relaxed">
          DC Palaran serves as the premier Transit Hub and Buffer Stock Center, ensuring seamless inventory stability.
        </p>
      </div>
    </div>
  </div>
);

const ObjectiveSection = () => (
  <section className="py-20 bg-white">
    <div className="max-w-7xl mx-auto px-4 grid grid-cols-1 lg:grid-cols-2 gap-16 items-center">
        <div>
            <h2 className="text-orange-500 font-bold uppercase tracking-widest text-sm mb-2">Our Core Mission</h2>
            <h3 className="text-4xl font-bold text-slate-900 mb-6">Optimizing Inventory Utilization & Stabilization</h3>
            <p className="text-slate-600 text-lg leading-relaxed mb-6">The primary objective of DC Palaran is to function as the stabilizing force across the entire supply chain.</p>
            <ul className="space-y-4">
                {['Centralized Buffer Stock Management', 'Reduction of Site-Level Deadstock', 'Rapid Deployment to Satellite Projects'].map((item, i) => (
                  <li key={i} className="flex items-center text-slate-700 font-medium">
                    <div className="mr-3 bg-slate-100 p-1 rounded-full text-orange-500"><ShieldCheck className="h-5 w-5"/></div>
                    {item}
                  </li>
                ))}
            </ul>
        </div>
        <div className="relative">
            <div className="absolute -inset-4 bg-orange-100 rounded-xl transform rotate-2"></div>
            <img src="https://images.unsplash.com/photo-1553413077-190dd305871c?ixlib=rb-4.0.3&auto=format&fit=crop&w=1035&q=80" className="relative rounded-lg shadow-2xl w-full object-cover h-96" alt="Warehouse" />
            <div className="absolute bottom-6 left-6 bg-slate-900 p-6 rounded-lg shadow-xl max-w-xs border-l-4 border-orange-500">
              <p className="text-slate-400 text-sm uppercase font-semibold mb-1">Efficiency Rate</p>
              <div className="flex items-end"><span className="text-4xl font-bold text-white">99.8%</span><span className="text-orange-500 ml-2 mb-1 font-medium">Stock Accuracy</span></div>
            </div>
        </div>
    </div>
  </section>
);

const KeyFunctions = () => {
  const funcs = [
    { icon: Truck, title: "Strategic Transit Hub", desc: "Acting as the primary consolidation point for vendors." },
    { icon: Database, title: "Buffer Stock Center", desc: "Managing volatility through three core pillars." },
    { icon: BarChart3, title: "Inventory Stabilization", desc: "The control tower for MIN-MAX levels." }
  ];
  return (
    <section id="functions" className="py-20 bg-slate-50">
        <div className="max-w-7xl mx-auto px-4 text-center mb-16">
            <h2 className="text-3xl md:text-4xl font-bold text-slate-900 mb-4">Key Operational Functions</h2>
            <div className="w-24 h-1 bg-orange-500 mx-auto rounded-full"></div>
        </div>
        <div className="max-w-7xl mx-auto px-4 grid grid-cols-1 md:grid-cols-3 gap-8">
            {funcs.map((f, i) => (
                <div key={i} className="bg-white rounded-xl shadow-lg p-8 border-t-4 border-transparent hover:border-orange-500 transition-all group">
                    <div className="mb-6 bg-slate-50 w-20 h-20 rounded-full flex items-center justify-center group-hover:bg-orange-50">
                        <f.icon className="h-10 w-10 text-orange-500" />
                    </div>
                    <h3 className="text-xl font-bold text-slate-900 mb-3">{f.title}</h3>
                    <p className="text-slate-600 leading-relaxed">{f.desc}</p>
                </div>
            ))}
        </div>
    </section>
  );
};

const CategoriesSection = () => {
  const cats = [
    { name: "Spare Parts", icon: Settings, img: "https://images.unsplash.com/photo-1486262715619-67b85e0b08d3?ixlib=rb-4.0.3" },
    { name: "Tyres & Rims", icon: Layers, img: "https://images.unsplash.com/photo-1583258509156-f28822026858?ixlib=rb-4.0.3" },
    { name: "Components", icon: Cpu, img: "https://images.unsplash.com/photo-1580894732930-0babd100d356?ixlib=rb-4.0.3" },
    { name: "General Supplies", icon: Box, img: "https://images.unsplash.com/photo-1595074474855-f9397f8ef5fd?ixlib=rb-4.0.3" }
  ];
  return (
    <section id="categories" className="py-20 bg-slate-900 text-white">
        <div className="max-w-7xl mx-auto px-4 mb-12">
           <h2 className="text-3xl font-bold mb-2">Material Categories</h2>
        </div>
        <div className="max-w-7xl mx-auto px-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            {cats.map((c, i) => (
                <div key={i} className="group relative h-96 rounded-lg overflow-hidden cursor-pointer">
                    <img src={`${c.img}&auto=format&fit=crop&w=600&q=80`} className="absolute inset-0 w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" alt={c.name} />
                    <div className="absolute inset-0 bg-gradient-to-t from-slate-900 via-slate-900/60 to-transparent opacity-90"></div>
                    <div className="absolute bottom-0 left-0 p-6 w-full">
                        <div className="bg-orange-500 w-12 h-12 rounded-lg flex items-center justify-center mb-4">
                            <c.icon className="text-white w-6 h-6" />
                        </div>
                        <h3 className="text-xl font-bold mb-2 border-l-4 border-orange-500 pl-3">{c.name}</h3>
                    </div>
                </div>
            ))}
        </div>
    </section>
  );
};

const ProcessSection = () => (
    <section id="process" className="py-20 bg-white">
        <div className="max-w-7xl mx-auto px-4 text-center mb-16">
            <h2 className="text-3xl font-bold text-slate-900">Operational Process Flow</h2>
        </div>
        <div className="max-w-7xl mx-auto px-4 relative">
            <div className="hidden md:block absolute top-1/2 left-0 w-full h-1 bg-slate-200 -translate-y-1/2 z-0"></div>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-12 relative z-10">
                {['Incoming & QC', 'Inventory Mgmt', 'Outgoing & Dispatch'].map((t, i) => (
                    <div key={i} className="bg-white p-6 rounded-xl border border-slate-100 shadow-lg text-center">
                        <div className={`w-16 h-16 ${i===1?'bg-orange-500':'bg-slate-900'} text-white rounded-full flex items-center justify-center text-2xl font-bold mx-auto mb-6 ring-8 ring-white`}>{i+1}</div>
                        <h3 className="text-xl font-bold text-slate-800 mb-3">{t}</h3>
                        <p className="text-slate-500 text-sm">Critical procedures ensuring operational excellence.</p>
                    </div>
                ))}
            </div>
        </div>
    </section>
);

const TrackingSection = () => {
    const [stoInput, setStoInput] = useState('');
    const [result, setResult] = useState(null);
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState(null);
    const [pendingGR, setPendingGR] = useState([]);

    useEffect(() => {
        const fetchPending = async () => {
            try {
                // Fetch data for home page alert
                const response = await fetch('https://docs.google.com/spreadsheets/d/1ULpZq-bZwvTaEfQ3EcnfTjOm3mOW23rhxGK1OZYBesI/export?format=csv&gid=0');
                const text = await response.text();
                // Correct CSV regex parser
                const rows = text.split('\n').map(row => {
                    const regex = /(?:,|\n|^)("(?:(?:"")*[^"]*)*"|[^",\n]*|(?:\n|$))/g;
                    const matches = [];
                    let match;
                    while ((match = regex.exec(row))) {
                        let val = match[1];
                        if(val && val.startsWith('"') && val.endsWith('"')) val = val.slice(1, -1);
                        matches.push(val ? val.trim() : '');
                    }
                    return matches;
                });

                const today = new Date();
                const pending = [];
                
                rows.slice(1).forEach(row => {
                     const dateStr = row[0]; // Col A is Date
                     const sto = row[6]; // Col G
                     const project = row[35]; // Col AJ

                     if (dateStr && sto) {
                        let sentDate = new Date(dateStr);
                        if (isNaN(sentDate.getTime())) {
                            const parts = dateStr.split(/[-/]/);
                            if(parts.length === 3) sentDate = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
                        }

                        if(!isNaN(sentDate.getTime())) {
                             const diff = Math.ceil((today - sentDate) / (1000 * 60 * 60 * 24));
                             if (diff > 30) {
                                 pending.push({ sto, project, days: diff, date: dateStr });
                             }
                        }
                     }
                });
                setPendingGR(pending.slice(0, 5)); // Limit for home display
            } catch(e) { console.error(e); }
        };
        fetchPending();
    }, []);

    const handleTrack = async (e) => {
        e.preventDefault();
        if(!stoInput) return;
        setLoading(true);
        setError(null);
        setResult(null);

        try {
            const response = await fetch('https://docs.google.com/spreadsheets/d/1ULpZq-bZwvTaEfQ3EcnfTjOm3mOW23rhxGK1OZYBesI/export?format=csv&gid=0');
            const text = await response.text();
            
            // Correct CSV Parser
            const rows = text.split('\n').map(row => {
                const regex = /(?:,|\n|^)("(?:(?:"")*[^"]*)*"|[^",\n]*|(?:\n|$))/g;
                const matches = [];
                let match;
                while ((match = regex.exec(row))) {
                    let val = match[1];
                    if(val && val.startsWith('"') && val.endsWith('"')) val = val.slice(1, -1);
                    matches.push(val ? val.trim() : '');
                }
                return matches;
            });

            const found = rows.find(r => r[6] && r[6].replace(/['"]/g, '').trim() === stoInput.trim());

            if (found) {
                const rawStatus = (found[33] || '').toUpperCase();
                const project = found[35] || 'Unknown';
                let activeIndex = 0;
                
                if (rawStatus.includes('WAITING') || rawStatus.includes('PACKING')) activeIndex = 1;
                else if (rawStatus.includes('TERKIRIM') || rawStatus.includes('DISPATCH')) activeIndex = 2;
                else if (rawStatus.includes('DELIVERED') || rawStatus.includes('SAMPAI')) activeIndex = 3;

                setResult({ status: rawStatus, project, activeIndex });
            } else {
                setError("STO Not Found");
            }
        } catch (err) {
            setError("Connection Error");
            console.error(err);
        } finally {
            setLoading(false);
        }
    };

    const steps = [
        { title: 'Order Confirmed (Realized)', sub: 'STO verified by DC Palaran', icon: CheckCircle },
        { title: 'Picking & Packing', sub: 'Items being retrieved from Bin Location & Staging and manifest generation', icon: Package },
        { title: 'Dispatched', sub: 'Handed over to transporter', icon: Truck },
        { title: 'Delivered', sub: 'Received at Site Warehouse', icon: MapPin }
    ];

    return (
        <section id="tracking" className="py-20 bg-slate-50 border-b border-slate-200">
            <div className="max-w-7xl mx-auto px-4">
                <div className="bg-white rounded-2xl shadow-xl overflow-hidden flex flex-col md:flex-row">
                    <div className="md:w-5/12 bg-slate-900 p-10 text-white flex flex-col justify-center">
                        <h2 className="text-3xl font-bold mb-4 flex items-center"><Search className="mr-3 text-orange-500" /> Track Shipment</h2>
                        <p className="text-slate-300">Monitor real-time status via STO Number.</p>
                    </div>
                    <div className="md:w-7/12 p-10">
                        <form onSubmit={handleTrack} className="mb-8">
                            <label className="block text-sm font-bold text-slate-900 mb-2 uppercase">Enter STO Number</label>
                            <div className="flex gap-2">
                                <input 
                                    type="text" 
                                    value={stoInput}
                                    onChange={(e) => setStoInput(e.target.value)}
                                    placeholder="e.g. 450012345" 
                                    className="flex-1 px-4 py-3 border border-slate-300 rounded-sm focus:ring-2 focus:ring-orange-500 outline-none"
                                />
                                <button type="submit" className="bg-orange-500 text-white font-bold px-8 py-3 rounded-sm hover:bg-orange-600">Track</button>
                            </div>
                        </form>

                        {loading && <div className="text-center p-4 text-slate-500 flex justify-center"><Loader2 className="animate-spin mr-2" /> Searching...</div>}
                        {error && <div className="text-red-500 p-4 font-bold text-center">{error}</div>}
                        
                        {result && (
                            <div className="animate-in slide-in-from-bottom duration-500">
                                <div className="bg-slate-50 border border-slate-200 rounded-lg p-4 mb-6 flex justify-between items-center">
                                    <div>
                                        <div className="text-xs text-slate-500 uppercase font-bold">Project</div>
                                        <div className="text-lg font-bold text-slate-900">{result.project}</div>
                                    </div>
                                    <div className="text-right">
                                        <div className="text-xs text-slate-500 uppercase font-bold">Status</div>
                                        <div className="text-sm font-bold text-orange-600">{result.status || 'CONFIRMED'}</div>
                                    </div>
                                </div>
                                <div className="space-y-8 relative pl-2 mt-8">
                                    <div className="absolute left-6 top-2 bottom-4 w-0.5 bg-slate-200 -z-10"></div>
                                    {steps.map((step, idx) => {
                                        const isActive = idx <= result.activeIndex;
                                        const isCurrent = idx === result.activeIndex;
                                        
                                        let bgColor = 'bg-slate-200 text-slate-400';
                                        if (isActive) {
                                            if (idx === 0) bgColor = 'bg-red-600 text-white shadow-lg shadow-red-200';
                                            else if (idx === 1) bgColor = 'bg-yellow-500 text-white shadow-lg shadow-yellow-200';
                                            else if (idx === 2) bgColor = 'bg-lime-500 text-white shadow-lg shadow-lime-200';
                                            else if (idx === 3) bgColor = 'bg-green-700 text-white shadow-lg shadow-green-200';
                                        }

                                        return (
                                            <div key={idx} className={`relative flex items-start group ${isActive ? '' : 'opacity-50'}`}>
                                                <div className={`w-8 h-8 rounded-full flex items-center justify-center relative z-10 transition-all ${bgColor} ${isCurrent ? 'scale-110 ring-4 ring-white shadow-lg' : ''}`}>
                                                    <step.icon className="w-4 h-4" />
                                                </div>
                                                <div className="ml-6 pt-1">
                                                    <h4 className="font-bold text-slate-900">{step.title}</h4>
                                                    <p className="text-xs text-slate-500">{step.sub}</p>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}
                    </div>
                </div>

                {/* ALARM SECTION ON HOME */}
                {pendingGR.length > 0 && (
                    <div className="mt-8 bg-slate-900 rounded-2xl p-2 shadow-xl animate-in slide-in-from-top duration-700">
                        <div className="space-y-4">
                            <div className="bg-red-500/10 border border-red-500/50 rounded-xl p-6">
                                <div className="flex items-center mb-4">
                                    <div className="bg-red-500 p-2 rounded-lg mr-4 animate-pulse"><AlertTriangle className="text-white w-6 h-6" /></div>
                                    <div>
                                        <h3 className="text-xl font-bold text-white">Action Required: Overdue Goods Receipt</h3>
                                        <p className="text-red-300 text-sm">Shipments older than 30 days pending confirmation.</p>
                                    </div>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {pendingGR.map((item, i) => (
                                        <div key={i} className="bg-red-500/20 p-3 rounded-lg border border-red-500/30 flex justify-between items-center">
                                            <div>
                                                <div className="font-bold text-white text-sm">{item.project}</div>
                                                <div className="text-xs text-red-200">STO: {item.sto}</div>
                                            </div>
                                            <div className="text-right">
                                                <div className="font-bold text-red-400 text-lg">{item.days} Days</div>
                                                <div className="text-[10px] text-red-300">Since {item.date}</div>
                                            </div>
                                        </div>
                                    ))}
                                    <div className="col-span-full text-center mt-2 font-bold text-white animate-pulse">
                                        "Please complete Goods Receipt immediately before requesting new items."
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        </section>
    );
};

const ContactSection = () => {
    const handleWA = (e) => {
        e.preventDefault();
        const site = e.target.site.value;
        const type = e.target.type.value;
        const item = e.target.item.value;
        if(!site) return alert("Pilih Site");
        const msg = `Halo Admin, cek stock:\nSite: ${site}\nItem (${type}): ${item}`;
        window.open(`https://wa.me/628115550123?text=${encodeURIComponent(msg)}`, '_blank');
    };

    const plants = [
        {code: "PL01", name: "MSJ"}, {code: "PL03", name: "BE"}, {code: "PL06", name: "KALSEL"}, 
        {code: "PL09", name: "MME"}, {code: "PL14", name: "TJP"}, {code: "PL15", name: "GAM"}, 
        {code: "PL18", name: "ABP"}, {code: "PL19", name: "GSP"}, {code: "PL22", name: "MRW"}
    ];

    return (
        <section id="contact" className="py-20 bg-slate-900 text-white">
            <div className="max-w-7xl mx-auto px-4 grid grid-cols-1 md:grid-cols-2 gap-16">
                <div>
                    <h2 className="text-3xl font-bold mb-6">Contact Control Tower</h2>
                    <div className="space-y-6">
                        <div className="flex items-start"><MapPin className="w-6 h-6 text-orange-500 mr-4"/><div><h4 className="font-bold">DC Palaran Main Hub</h4><p className="text-slate-400 text-sm">Jl. Trikora, Palaran, Samarinda</p></div></div>
                        <div className="flex items-center"><Phone className="w-6 h-6 text-orange-500 mr-4"/><div><h4 className="font-bold">Hotline</h4><p className="text-slate-400 text-sm">+62 811-555-0123</p></div></div>
                    </div>
                </div>
                <div className="bg-white rounded-lg p-8 text-slate-900">
                    <h3 className="text-2xl font-bold text-slate-900 mb-6">Quick Stock Check</h3>
                    <form onSubmit={handleWA} className="space-y-4">
                        <div>
                            <label className="block text-sm font-bold mb-2">Project Site</label>
                            <select name="site" className="w-full px-4 py-3 bg-slate-100 border-none rounded-sm" defaultValue="">
                                <option value="" disabled>Select Site...</option>
                                {plants.map(p => <option key={p.code} value={`${p.name} (${p.code})`}>{p.name} ({p.code})</option>)}
                            </select>
                        </div>
                        <div>
                            <label className="block text-sm font-bold mb-2">Search By</label>
                            <div className="flex gap-4 mb-2">
                                <label className="flex items-center space-x-2"><input type="radio" name="type" value="Material Number" defaultChecked /><span>Material Number</span></label>
                                <label className="flex items-center space-x-2"><input type="radio" name="type" value="Part Number" /><span>Part Number</span></label>
                            </div>
                            <input name="item" type="text" className="w-full px-4 py-3 bg-slate-100 border-none rounded-sm" placeholder="Enter Number..." required />
                        </div>
                        <button type="submit" className="w-full bg-green-600 text-white font-bold py-3 rounded-sm hover:bg-green-700 flex items-center justify-center">
                            <Send className="w-4 h-4 mr-2" /> Check Stock via WhatsApp
                        </button>
                    </form>
                </div>
            </div>
        </section>
    );
};

const Footer = () => (
    <footer className="bg-slate-950 text-slate-400 py-8 text-center border-t border-slate-900">
        <p>&copy; 2025 DC Palaran. All rights reserved.</p>
    </footer>
);

// --- ANALYSIS LANDING ---
const AnalysisLanding = ({ onNavigate }) => (
    <div className="min-h-screen pt-24 pb-12 bg-slate-900 text-white animate-in">
        <div className="max-w-7xl mx-auto px-4 text-center mb-12">
            <h2 className="text-4xl font-extrabold mb-4">Analysis Tools</h2>
            <button onClick={() => onNavigate('home')} className="text-orange-500 hover:text-orange-400">Back to Home</button>
        </div>
        <div className="max-w-7xl mx-auto px-4 grid grid-cols-1 md:grid-cols-3 gap-8">
            <div onClick={() => window.open('https://fff-class.vercel.app/', '_blank')} className="bg-slate-800 rounded-2xl p-8 border border-slate-700 hover:border-orange-500 cursor-pointer group relative overflow-hidden">
                <div className="absolute top-0 right-0 w-32 h-32 bg-orange-500 opacity-10 rounded-bl-full -mr-8 -mt-8 transition-transform group-hover:scale-110"></div>
                <div className="w-16 h-16 bg-orange-500 rounded-2xl flex items-center justify-center mb-6 relative z-10"><GitMerge className="w-8 h-8 text-white" /></div>
                <h3 className="text-xl font-bold mb-3 relative z-10">FFF Class Analysis</h3>
                <p className="text-slate-400 text-sm mb-6 relative z-10">Detect Form-Fit-Function interchangeability.</p>
                <span className="text-xs font-bold uppercase text-slate-500 group-hover:text-white flex items-center relative z-10">Launch Tool <ArrowRight className="ml-2 w-4 h-4" /></span>
            </div>
            <div onClick={() => window.open('https://analisis-pr-oustanding-dc-palaran.vercel.app/', '_blank')} className="bg-slate-800 rounded-2xl p-8 border border-slate-700 hover:border-blue-500 cursor-pointer group relative overflow-hidden">
                <div className="absolute top-0 right-0 w-32 h-32 bg-blue-600 opacity-10 rounded-bl-full -mr-8 -mt-8 transition-transform group-hover:scale-110"></div>
                <div className="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center mb-6 relative z-10"><BarChart3 className="w-8 h-8 text-white" /></div>
                <h3 className="text-xl font-bold mb-3 relative z-10">PR OS Analysis</h3>
                <p className="text-slate-400 text-sm mb-6 relative z-10">Prioritize stock allocation over purchasing.</p>
                <span className="text-xs font-bold uppercase text-slate-500 group-hover:text-white flex items-center relative z-10">Launch Tool <ArrowRight className="ml-2 w-4 h-4" /></span>
            </div>
            <div onClick={() => window.open('https://block-master-dc-palaran.vercel.app/', '_blank')} className="bg-slate-800 rounded-2xl p-8 border border-slate-700 hover:border-slate-500 cursor-pointer group relative overflow-hidden">
                <div className="absolute top-0 right-0 w-32 h-32 bg-slate-600 opacity-10 rounded-bl-full -mr-8 -mt-8 transition-transform group-hover:scale-110"></div>
                <div className="w-16 h-16 bg-slate-600 rounded-2xl flex items-center justify-center mb-6 relative z-10"><AlertTriangle className="w-8 h-8 text-white" /></div>
                <h3 className="text-xl font-bold mb-3 relative z-10">Block Master</h3>
                <p className="text-slate-400 text-sm mb-6 relative z-10">Analyze deadstock and blockage status.</p>
                <span className="text-xs font-bold uppercase text-slate-500 group-hover:text-white flex items-center relative z-10">Launch Tool <ArrowRight className="ml-2 w-4 h-4" /></span>
            </div>
        </div>
    </div>
);

// --- CATALOG REQUEST SECTION ---
const CatalogRequestSection = ({ onBack }) => {
    // ... State for ZERPD and Form ...
    const [zerpdData, setZerpdData] = useState(new Map());
    const [isZerpdUploaded, setIsZerpdUploaded] = useState(false);
    const [mpnStatus, setMpnStatus] = useState('');
    const [mpnStatusType, setMpnStatusType] = useState(''); // success, error
    const [existingMatch, setExistingMatch] = useState(null);
    const [isLocked, setIsLocked] = useState(true);

    const handleZerpdUpload = async (e) => {
        const file = e.target.files[0];
        if(!file) return;

        // Validasi Nama File
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        const format1 = `${year}${month}${day}`; 
        const format2 = `${day}${month}${year}`;
        const requiredPhrase = "ZERPD ALL SITE";

        if ((!file.name.includes(format1) && !file.name.includes(format2)) || !file.name.toUpperCase().includes(requiredPhrase)) {
            alert(`Nama file tidak valid! Harus mengandung tanggal hari ini (${format1} atau ${format2}) dan "ZERPD ALL SITE".`);
            e.target.value = '';
            return;
        }

        // --- Load XLSX Dynamically ---
        if (!window.XLSX) await loadXLSX();
        const XLSX = window.XLSX;

        const buffer = await file.arrayBuffer();
        const workbook = XLSX.read(new Uint8Array(buffer), { type: 'array' });
        const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });

        if(jsonData.length < 2) return;

        // Simple Heuristic for columns
        const headers = jsonData[0].map(h => String(h).toLowerCase().replace(/[^a-z0-9]/g, ''));
        let mpnIdx = headers.findIndex(h => h.includes('manufact') && (h.includes('part') || h.includes('no')));
        let matIdx = headers.findIndex(h => h.includes('material') && !h.includes('desc'));
        if(mpnIdx === -1) mpnIdx = 2; 
        if(matIdx === -1) matIdx = 0; 

        const newMap = new Map();
        for(let i=1; i<jsonData.length; i++) {
            const row = jsonData[i];
            const rawMPN = String(row[mpnIdx] || '').trim();
            const mat = String(row[matIdx] || '').trim();
            if(rawMPN && rawMPN.length > 1) {
                newMap.set(normalizeString(rawMPN), { original: rawMPN, material: mat });
            }
        }
        setZerpdData(newMap);
        setIsZerpdUploaded(true);
    };

    const handleVerifyMPN = (val) => {
        const normVal = normalizeString(val);
        if(!normVal) return;

        if(zerpdData.has(normVal)) {
            const match = zerpdData.get(normVal);
            setMpnStatus("DUPLICATE FOUND");
            setMpnStatusType("error");
            setExistingMatch(match);
            setIsLocked(true);
        } else {
            setMpnStatus("AVAILABLE");
            setMpnStatusType("success");
            setExistingMatch(null);
            setIsLocked(false);
        }
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        if(!auth.currentUser) {
            try { await signInAnonymously(auth); } catch(err) { alert("Auth failed"); return; }
        }
        
        const form = e.target;
        const formData = {
            requester_name: form.requester_name.value,
            // ... collect other fields ...
            timestamp: serverTimestamp()
        };

        try {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'requests'), formData);
            alert("Request submitted!");
            form.reset();
        } catch(err) { alert("Failed to submit"); }
    };

    // Options Generators
    const plantOptions = Array.from({length: 28}, (_, i) => `PL${String(i + 1).padStart(2, '0')}`);
    const storageLocOptions = Array.from({length: 15}, (_, i) => `S${String(i + 1).padStart(3, '0')}`);
    const matTypes = ["SPRT", "FOGC", "TIRE", "CONS", "GENS", "ASET", "SEJA", "MDLE", "BOMM", "FFF"];
    const matGroups = ["S001", "S002", "S003", "S004", "S005", "S006", "F001", "F002", "F003", "F004", "T001", "G001", "G002", "C001", "C002", "C003", "C004", "C005", "C006", "C007", "A001", "A002", "A003", "A004", "A005", "A006", "J001", "J002", "J003", "J004", "J005", "J006", "J007", "J008", "J009", "J010", "J011", "J012", "J013", "J014", "J015", "M001"];
    const purchGroups = ["G01", "G02", "G03", "G04", "G05", "G06", "G07"];
    const valClasses = ["V001", "V002", "V003", "V004", "V005", "V006", "V007", "V008", "V009", "V010", "V011", "V012", "V013", "V014", "V015", "V016", "V017", "V018", "V019", "V020", "V021", "V022", "V023", "V024", "V025", "V026", "V027", "V028", "V029", "V030", "V031", "V032", "V033", "V034", "V035"];

    const inputClass = "w-full px-3 py-2 border border-slate-300 rounded focus:ring-2 focus:ring-orange-500 outline-none";
    const lockedClass = "bg-slate-100 text-slate-400 cursor-not-allowed";

    return (
        <div className="min-h-screen pt-24 pb-12 bg-slate-50 text-slate-900 animate-in">
            <div className="max-w-6xl mx-auto px-4">
                <button onClick={onBack} className="mb-6 flex items-center text-slate-500 hover:text-orange-600 font-medium text-sm"><ArrowLeft className="w-4 h-4 mr-2" /> Back</button>
                
                <div className="bg-white rounded-xl shadow-xl overflow-hidden border border-slate-200">
                    <div className="bg-slate-900 p-8 text-white">
                         <h2 className="text-3xl font-bold mb-2 flex items-center"><FileText className="mr-3 text-orange-500" /> New Material Request</h2>
                         <p className="text-slate-400">Formulir registrasi Master Data Material baru.</p>
                    </div>
                    <div className="p-8">
                        {/* ZERPD SECTION */}
                        <div className="bg-orange-50 border border-orange-200 rounded-lg p-6 mb-8">
                            <div className="flex justify-between items-start">
                                <div>
                                    <h4 className="font-bold text-orange-800 mb-2 flex items-center"><ShieldCheck className="w-5 h-5 mr-2" /> Duplicate Check (ZERPD)</h4>
                                    <p className="text-sm text-orange-700 mb-4">Upload file <strong>ZERPD.xlsx</strong> (Nama file harus mengandung tanggal hari ini & "ZERPD ALL SITE") untuk membuka formulir.</p>
                                </div>
                                {isZerpdUploaded && <button onClick={() => { setIsZerpdUploaded(false); setZerpdData(new Map()); setIsLocked(true); }} className="text-red-500 hover:text-red-700 flex items-center text-sm font-bold"><Trash2 className="w-4 h-4 mr-1" /> Remove File</button>}
                            </div>
                            {!isZerpdUploaded ? (
                                <input type="file" accept=".xlsx" onChange={handleZerpdUpload} className="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-orange-500 file:text-white hover:file:bg-orange-600"/>
                            ) : (
                                <div className="text-sm font-bold text-green-600">ZERPD File Loaded. Ready to verify.</div>
                            )}
                        </div>

                        <form onSubmit={handleSubmit} className="space-y-8">
                            {/* Requester Info */}
                            <div className="bg-slate-50 p-6 rounded-lg border border-slate-200">
                                <h4 className="font-bold text-slate-800 mb-4 pb-2 border-b border-slate-300">Requester Information</h4>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Requester Name</label><input required name="requester_name" type="text" className={inputClass} /></div>
                                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Department</label><input required name="department" type="text" className={inputClass} /></div>
                                </div>
                            </div>

                            {/* MPN Verification */}
                            <div className="bg-blue-50 p-6 rounded-lg border border-blue-200">
                                <h4 className="font-bold text-blue-900 mb-4 pb-2 border-b border-blue-300">Part Number Verification</h4>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Manufacturing Part Number</label>
                                        <div className="flex gap-2">
                                            <input id="inputMPN" disabled={!isZerpdUploaded} className={`${inputClass} ${!isZerpdUploaded ? lockedClass : ''}`} placeholder="Upload ZERPD first..." />
                                            <button type="button" onClick={() => handleVerifyMPN(document.getElementById('inputMPN').value)} disabled={!isZerpdUploaded} className="bg-blue-600 text-white px-6 py-2 rounded text-xs font-bold hover:bg-blue-700 disabled:opacity-50">VERIFY</button>
                                        </div>
                                    </div>
                                    <div className="flex items-center">
                                        <p className={`text-sm font-bold ml-2 ${mpnStatusType === 'error' ? 'text-red-600' : 'text-green-600'}`}>{mpnStatus}</p>
                                    </div>
                                    {mpnStatusType === 'error' && (
                                        <div className="md:col-span-2 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded shadow-sm">
                                            <p className="font-bold">Mohon pastikan kembali PN dikarenakan PN sdh terdaftar di ZERPD</p>
                                            <p className="text-sm mt-1">Existing Match: <span className="font-mono bg-red-200 px-1 rounded">{existingMatch?.original}</span> (Material: {existingMatch?.material})</p>
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* Basic Data */}
                            <div>
                                <h4 className="font-bold text-slate-800 mb-4">1. Basic Material Data</h4>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div className="md:col-span-3"><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Description</label><input required disabled={isLocked} name="description" type="text" className={`${inputClass} ${isLocked ? lockedClass : ''}`} /></div>
                                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Old Material Number</label><input disabled={isLocked} name="old_material_number" type="text" className={`${inputClass} ${isLocked ? lockedClass : ''}`} /></div>
                                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Material Type</label><select disabled={isLocked} name="material_type" className={`${inputClass} ${isLocked ? lockedClass : ''}`} defaultValue=""><option value="" disabled>Select...</option>{matTypes.map(t => <option key={t} value={t}>{t}</option>)}</select></div>
                                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Base UoM</label><input disabled={isLocked} name="base_uom" type="text" className={`${inputClass} ${isLocked ? lockedClass : ''}`} /></div>
                                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Material Group</label><select disabled={isLocked} name="material_group" className={`${inputClass} ${isLocked ? lockedClass : ''}`} defaultValue=""><option value="" disabled>Select...</option>{matGroups.map(g => <option key={g} value={g}>{g}</option>)}</select></div>
                                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Plant</label><select required disabled={isLocked} name="plant" className={`${inputClass} ${isLocked ? lockedClass : ''}`} defaultValue=""><option value="" disabled>Select...</option>{plantOptions.map(p => <option key={p} value={p}>{p}</option>)}</select></div>
                                </div>
                            </div>

                            {/* Manufacturing */}
                            <div>
                                <h4 className="font-bold text-slate-800 mb-4">2. Manufacturing & Purchasing</h4>
                                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                    <div className="md:col-span-2"><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Manuf. Part Profile</label><input disabled={isLocked} name="manuf_profile" type="text" className={`${inputClass} ${isLocked ? lockedClass : ''}`} /></div>
                                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Purchasing Group</label><select disabled={isLocked} name="purch_group" className={`${inputClass} ${isLocked ? lockedClass : ''}`} defaultValue=""><option value="" disabled>Select...</option>{purchGroups.map(g => <option key={g} value={g}>{g}</option>)}</select></div>
                                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Automatic PO</label><select disabled={isLocked} name="auto_po" className={`${inputClass} ${isLocked ? lockedClass : ''}`} defaultValue="Yes"><option value="Yes">Yes</option><option value="No">No</option></select></div>
                                </div>
                            </div>

                             {/* MRP */}
                             <div>
                                <h4 className="font-bold text-slate-800 mb-4">3. MRP & Planning</h4>
                                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">MRP Type</label><input disabled={isLocked} name="mrp_type" type="text" className={`${inputClass} bg-slate-100`} defaultValue="ND" readOnly /></div>
                                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">MRP Controller</label><input disabled={isLocked} name="mrp_controller" type="text" className={`${inputClass} bg-slate-100`} defaultValue="M01" readOnly /></div>
                                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Reorder Point</label><input disabled={isLocked} name="reorder_point" type="number" className={`${inputClass} bg-slate-100`} defaultValue="0" readOnly /></div>
                                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Lot Sizing</label><input disabled={isLocked} name="lot_sizing" type="text" className={`${inputClass} ${isLocked ? lockedClass : ''}`} /></div>
                                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Max Stock</label><input disabled={isLocked} name="max_stock" type="number" className={`${inputClass} bg-slate-100`} defaultValue="0" readOnly /></div>
                                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Safety Stock</label><input disabled={isLocked} name="safety_stock" type="number" className={`${inputClass} bg-slate-100`} defaultValue="0" readOnly /></div>
                                    <div className="md:col-span-2"><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Planned Deliv. Time</label><input disabled={isLocked} name="planned_deliv_time" type="number" className={`${inputClass} bg-slate-100`} defaultValue="28" readOnly /></div>
                                </div>
                            </div>

                            {/* Storage */}
                            <div>
                                <h4 className="font-bold text-slate-800 mb-4">4. Procurement & Storage</h4>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Procurement Type</label><input disabled={isLocked} name="procurement_type" type="text" className={`${inputClass} bg-slate-100`} defaultValue="F" readOnly /></div>
                                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Special Procurement</label><input disabled={isLocked} name="special_procure" type="text" className={`${inputClass} bg-slate-100`} defaultValue="40" readOnly /></div>
                                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Valuation Cat</label><input disabled={isLocked} name="valuation_cat" type="text" className={`${inputClass} bg-slate-100`} defaultValue="S" readOnly /></div>
                                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Valuation Class</label><select disabled={isLocked} name="valuation_class" className={`${inputClass} ${isLocked ? lockedClass : ''}`} defaultValue=""><option value="" disabled>Select...</option>{valClasses.map(v => <option key={v} value={v}>{v}</option>)}</select></div>
                                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Storage Loc</label><select disabled={isLocked} name="storage_loc" className={`${inputClass} ${isLocked ? lockedClass : ''}`} defaultValue=""><option value="" disabled>Select...</option>{storageLocOptions.map(s => <option key={s} value={s}>{s}</option>)}</select></div>
                                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Storage Bin</label><input disabled={isLocked} name="storage_bin" type="text" className={`${inputClass} ${isLocked ? lockedClass : ''}`} /></div>
                                    <div className="md:col-span-3"><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Serial Number Profile</label><input disabled={isLocked} name="serial_profile" type="text" className={`${inputClass} ${isLocked ? lockedClass : ''}`} /></div>
                                </div>
                            </div>

                            <div className="pt-6 border-t border-slate-200">
                                <button type="submit" disabled={isLocked} className={`w-full font-bold py-4 rounded-md flex justify-center items-center text-lg ${isLocked ? 'bg-slate-300 text-white cursor-not-allowed' : 'bg-orange-500 hover:bg-orange-600 text-white shadow-lg'}`}>
                                    {isLocked ? <><ShieldCheck className="w-5 h-5 mr-2" /> Verify MPN to Unlock Submit</> : <><Send className="w-5 h-5 mr-2" /> Submit Request</>}
                                </button>
                            </div>

                        </form>
                    </div>
                </div>
            </div>
        </div>
    );
};

// --- DASHBOARD SECTION (UPDATED with Reports & Charts) ---

const SimpleDonutChart = ({ data, size = 160 }) => {
    const total = data.reduce((acc, curr) => acc + curr.value, 0);
    let cumulativePercent = 0;
  
    const getCoordinatesForPercent = (percent) => {
      const x = Math.cos(2 * Math.PI * percent);
      const y = Math.sin(2 * Math.PI * percent);
      return [x, y];
    };
  
    return (
      <div className="relative flex justify-center items-center">
        <svg viewBox="-1 -1 2 2" width={size} height={size} style={{ transform: 'rotate(-90deg)' }}>
          {data.map((slice, i) => {
            const startPercent = cumulativePercent;
            const slicePercent = slice.value / total;
            cumulativePercent += slicePercent;
            const endPercent = cumulativePercent;
  
            const [startX, startY] = getCoordinatesForPercent(startPercent);
            const [endX, endY] = getCoordinatesForPercent(endPercent);
            const largeArcFlag = slicePercent > 0.5 ? 1 : 0;
            const pathData = `M ${startX} ${startY} A 1 1 0 ${largeArcFlag} 1 ${endX} ${endY} L 0 0`;
  
            return <path key={i} d={pathData} fill={slice.color} />;
          })}
          <circle cx="0" cy="0" r="0.6" fill="white" />
        </svg>
        <div className="absolute inset-0 flex flex-col items-center justify-center text-slate-800">
           <span className="text-xs font-bold uppercase">Total</span>
           <span className="text-sm font-extrabold">{formatIDR(total).replace('Rp', '')}</span>
        </div>
      </div>
    );
  };
  
  const SimpleBarChart = ({ data, maxVal }) => (
      <div className="space-y-3">
          {data.map((item, i) => (
              <div key={i}>
                  <div className="flex justify-between text-xs font-bold mb-1 text-slate-600">
                      <span>{item.label}</span>
                      <span>{formatIDR(item.value)}</span>
                  </div>
                  <div className="w-full bg-slate-200 rounded-full h-3 overflow-hidden">
                      <div 
                          className="h-full rounded-full transition-all duration-1000 bg-gradient-to-r from-orange-400 to-orange-600"
                          style={{ width: `${(item.value / maxVal) * 100}%` }}
                      ></div>
                  </div>
              </div>
          ))}
      </div>
  );

const DashboardSection = ({ onBack }) => {
  const [loading, setLoading] = useState(true);
  const [stats, setStats] = useState({ totalValue: 0, totalVolume: 0 });
  const [reportView, setReportView] = useState('YTD'); // 'YTD', 'Monthly', 'Weekly'
  const [selectedWeek, setSelectedWeek] = useState(1);
  const [reportData, setReportData] = useState([]);
  const [pendingGR, setPendingGR] = useState([]);

  // Mock Data Generator
  const generateReportData = () => {
    const sites = [
      { id: 'PL01', name: 'MSJ', share: 35 },
      { id: 'PL03', name: 'BE', share: 25 },
      { id: 'PL14', name: 'TJP', share: 15 },
      { id: 'PL22', name: 'MRW', share: 15 },
      { id: 'PL06', name: 'KALSEL', share: 10 }
    ];

    const getVal = (base, share) => Math.round((base * (share/100)) + (Math.random() * 50000000));

    return sites.map(site => {
      const ytdValue = getVal(15000000000, site.share);
      const monthlyTotal = getVal(2000000000, site.share);
      
      const weeks = {};
      let remainingMonthly = monthlyTotal;
      
      for(let w=1; w<=5; w++) {
        const weekVal = w === 5 ? remainingMonthly : Math.round(monthlyTotal / 5.5);
        remainingMonthly -= weekVal;

        const nonSoh = Math.round(weekVal * 0.2); 
        const sto = Math.round(weekVal * 0.6);   
        const tf = weekVal - nonSoh - sto;       

        weeks[w] = {
            total: weekVal,
            components: { nonSoh, sto, tf }
        };
      }

      return {
        ...site,
        ytd: { value: ytdValue, percentage: site.share },
        monthly: { value: monthlyTotal, percentage: site.share, weeks }
      };
    }).sort((a,b) => b.ytd.value - a.ytd.value);
  };

  useEffect(() => {
    const fetchData = async () => {
        // Mock Report Data
        const data = generateReportData();
        setReportData(data);
        setStats({
            totalValue: data.reduce((acc, curr) => acc + curr.ytd.value, 0),
            totalVolume: 1450
        });

        // Real Pending GR Data
        try {
            const response = await fetch('https://docs.google.com/spreadsheets/d/1ULpZq-bZwvTaEfQ3EcnfTjOm3mOW23rhxGK1OZYBesI/export?format=csv&gid=0');
            const text = await response.text();
            const rows = text.split('\n').map(row => {
                const regex = /(?:,|\n|^)("(?:(?:"")*[^"]*)*"|[^",\n]*|(?:\n|$))/g;
                const matches = [];
                let match;
                while ((match = regex.exec(row))) {
                    let val = match[1];
                    if(val && val.startsWith('"') && val.endsWith('"')) val = val.slice(1, -1);
                    matches.push(val ? val.trim() : '');
                }
                return matches;
            });

            const today = new Date();
            const pending = [];
            
            rows.slice(1).forEach(row => {
                     const dateStr = row[0]; // Col A
                     const sto = row[6]; // Col G
                     const project = row[35]; // Col AJ

                     if (dateStr && sto) {
                        let sentDate = new Date(dateStr);
                        if (isNaN(sentDate.getTime())) {
                            const parts = dateStr.split(/[-/]/);
                            if(parts.length === 3) sentDate = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
                        }

                        if(!isNaN(sentDate.getTime())) {
                             const diff = Math.ceil((today - sentDate) / (1000 * 60 * 60 * 24));
                             if (diff > 30) {
                                 pending.push({ sto, project, days: diff, date: dateStr });
                             }
                        }
                     }
            });
            setPendingGR(pending.slice(0, 5));
        } catch(e) { console.error(e); }

        setLoading(false);
    };
    fetchData();
  }, []);

  const calculateTotals = () => {
      if(reportView === 'YTD') return reportData.reduce((acc, curr) => acc + curr.ytd.value, 0);
      else if (reportView === 'Monthly') return reportData.reduce((acc, curr) => acc + curr.monthly.value, 0);
      else if (reportView === 'Weekly') return reportData.reduce((acc, curr) => acc + (curr.monthly.weeks[selectedWeek]?.total || 0), 0);
      return 0;
  };

  // Prepare chart data based on view
  const getChartData = () => {
      if (reportView === 'Weekly') {
          // Aggregate all sites for the selected week to get component breakdown
          const totalNonSoh = reportData.reduce((acc, curr) => acc + curr.monthly.weeks[selectedWeek].components.nonSoh, 0);
          const totalSto = reportData.reduce((acc, curr) => acc + curr.monthly.weeks[selectedWeek].components.sto, 0);
          const totalTf = reportData.reduce((acc, curr) => acc + curr.monthly.weeks[selectedWeek].components.tf, 0);
          
          return {
              type: 'donut',
              data: [
                  { label: 'STO', value: totalSto, color: '#f97316' }, // Orange
                  { label: 'Non SOH', value: totalNonSoh, color: '#3b82f6' }, // Blue
                  { label: 'TF Post', value: totalTf, color: '#94a3b8' } // Slate
              ]
          };
      } else {
          // Bar chart data for sites
          const data = reportData.map(site => ({
              label: site.name,
              value: reportView === 'YTD' ? site.ytd.value : site.monthly.value
          }));
          return { type: 'bar', data, maxVal: Math.max(...data.map(d => d.value)) * 1.1 };
      }
  };

  const chartData = getChartData();

  return (
    <section id="dashboard" className="min-h-screen pt-24 pb-12 bg-slate-950 text-white animate-in slide-in-from-right duration-500 relative overflow-hidden">
        <div className="absolute top-0 left-0 w-full h-96 bg-gradient-to-b from-slate-900 to-slate-950 z-0"></div>
        
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative z-10">
            {/* Header */}
            <div className="flex justify-between items-end mb-10">
                <div>
                    <button onClick={onBack} className="mb-6 flex items-center text-slate-400 hover:text-orange-400 transition-colors text-sm font-medium uppercase"><ArrowLeft className="w-4 h-4 mr-2" /> Back to Home</button>
                    <h2 className="text-4xl font-extrabold mb-2 text-white">Report Management</h2>
                    <p className="text-slate-400">Deadstock & Part Closing Utilization Analysis (DC Palaran)</p>
                </div>
            </div>

            {/* PENDING GR ALERT */}
            {pendingGR.length > 0 && (
                <div className="mb-10 bg-slate-900 rounded-2xl p-2 shadow-xl animate-in slide-in-from-top duration-700">
                    <div className="bg-red-500/10 border border-red-500/50 rounded-xl p-6">
                        <div className="flex items-center mb-4">
                            <div className="bg-red-500 p-2 rounded-lg mr-4 animate-pulse"><AlertTriangle className="text-white w-6 h-6" /></div>
                            <div>
                                <h3 className="text-xl font-bold text-white">Action Required: Overdue Goods Receipt</h3>
                                <p className="text-red-300 text-sm">Shipments older than 30 days pending confirmation.</p>
                            </div>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {pendingGR.map((item, i) => (
                                <div key={i} className="bg-red-500/20 p-3 rounded-lg border border-red-500/30 flex justify-between items-center">
                                    <div><div className="font-bold text-white text-sm">{item.project}</div><div className="text-xs text-red-200">STO: {item.sto}</div></div>
                                    <div className="text-right"><div className="font-bold text-red-400 text-lg">{item.days} Days</div><div className="text-[10px] text-red-300">Since {item.date}</div></div>
                                </div>
                            ))}
                            <div className="col-span-full text-center mt-2 font-bold text-white animate-pulse">"Please complete Goods Receipt immediately before requesting new items."</div>
                        </div>
                    </div>
                </div>
            )}

            {/* CONTROLS */}
            <div className="bg-slate-900/80 border border-slate-800 rounded-2xl p-2 mb-8 flex flex-col md:flex-row justify-between items-center gap-4">
                <div className="flex space-x-2">
                    <button onClick={() => setReportView('YTD')} className={`px-6 py-2 rounded-lg text-sm font-bold transition-all ${reportView === 'YTD' ? 'bg-orange-500 text-white shadow-lg' : 'text-slate-400 hover:bg-slate-800'}`}>YTD (July - Now)</button>
                    <button onClick={() => setReportView('Monthly')} className={`px-6 py-2 rounded-lg text-sm font-bold transition-all ${reportView === 'Monthly' ? 'bg-orange-500 text-white shadow-lg' : 'text-slate-400 hover:bg-slate-800'}`}>Monthly Report</button>
                    <button onClick={() => setReportView('Weekly')} className={`px-6 py-2 rounded-lg text-sm font-bold transition-all ${reportView === 'Weekly' ? 'bg-orange-500 text-white shadow-lg' : 'text-slate-400 hover:bg-slate-800'}`}>Weekly Breakdown</button>
                </div>
                {reportView === 'Weekly' && (
                    <div className="flex items-center space-x-2 pr-4">
                        <span className="text-xs text-slate-400 font-bold uppercase">Select Week:</span>
                        {[1, 2, 3, 4, 5].map(w => (
                            <button key={w} onClick={() => setSelectedWeek(w)} className={`w-8 h-8 rounded-full text-xs font-bold transition-all ${selectedWeek === w ? 'bg-blue-600 text-white' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}>{w}</button>
                        ))}
                    </div>
                )}
            </div>

            {/* MAIN CONTENT GRID */}
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                {/* LEFT: TABLE */}
                <div className="lg:col-span-2 bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200">
                    <div className="p-6 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
                        <h3 className="text-lg font-bold text-slate-800 flex items-center">
                            <BarChart3 className="w-5 h-5 mr-2 text-orange-600" />
                            Data Table
                        </h3>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full text-left text-sm text-slate-900">
                            <thead className="bg-slate-800 text-slate-200 font-bold uppercase text-xs">
                                <tr>
                                    <th className="p-4">Site Name</th>
                                    {reportView === 'Weekly' && <><th className="p-4 text-right">Non SOH</th><th className="p-4 text-right">STO</th><th className="p-4 text-right">TF Post</th></>}
                                    <th className="p-4 text-right">Total Value</th>
                                    <th className="p-4 text-center">Share %</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {reportData.map((row, idx) => {
                                    const total = calculateTotals();
                                    let displayValue, displayPercent;
                                    
                                    if (reportView === 'YTD') { displayValue = row.ytd.value; displayPercent = row.ytd.percentage; }
                                    else if (reportView === 'Monthly') { displayValue = row.monthly.value; displayPercent = (row.monthly.value / total) * 100; }
                                    else { displayValue = row.monthly.weeks[selectedWeek].total; displayPercent = (row.monthly.weeks[selectedWeek].total / total) * 100; }

                                    return (
                                        <tr key={idx} className="hover:bg-slate-50">
                                            <td className="p-4 font-bold text-slate-700">{row.name}</td>
                                            {reportView === 'Weekly' && (
                                                <>
                                                    <td className="p-4 text-right font-mono text-xs">{formatIDR(row.monthly.weeks[selectedWeek].components.nonSoh)}</td>
                                                    <td className="p-4 text-right font-mono text-xs">{formatIDR(row.monthly.weeks[selectedWeek].components.sto)}</td>
                                                    <td className="p-4 text-right font-mono text-xs">{formatIDR(row.monthly.weeks[selectedWeek].components.tf)}</td>
                                                </>
                                            )}
                                            <td className="p-4 text-right font-mono font-bold">{formatIDR(displayValue)}</td>
                                            <td className="p-4 text-center text-xs font-bold text-slate-500">{displayPercent.toFixed(1)}%</td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                             <tfoot className="bg-slate-100 border-t-2 border-slate-200">
                                <tr>
                                    <td className="p-4 font-bold text-slate-800">TOTAL</td>
                                    {reportView === 'Weekly' && <td colSpan="3"></td>}
                                    <td className="p-4 text-right font-mono font-extrabold text-orange-600">{formatIDR(calculateTotals())}</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                {/* RIGHT: CHARTS */}
                <div className="bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200 h-fit">
                    <div className="p-6 bg-slate-50 border-b border-slate-200">
                        <h3 className="text-lg font-bold text-slate-800 flex items-center">
                            <PieChart className="w-5 h-5 mr-2 text-blue-600" />
                            Visual Analysis
                        </h3>
                    </div>
                    <div className="p-8 flex flex-col items-center justify-center">
                        {chartData.type === 'donut' ? (
                            <div className="text-center">
                                <SimpleDonutChart data={chartData.data} />
                                <div className="mt-6 grid grid-cols-3 gap-2 text-center">
                                    {chartData.data.map((d, i) => (
                                        <div key={i} className="flex flex-col items-center">
                                            <span className="w-3 h-3 rounded-full mb-1" style={{backgroundColor: d.color}}></span>
                                            <span className="text-[10px] font-bold text-slate-500 uppercase">{d.label}</span>
                                            <span className="text-xs font-bold text-slate-800">{((d.value/calculateTotals())*100).toFixed(0)}%</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ) : (
                            <div className="w-full">
                                <SimpleBarChart data={chartData.data} maxVal={chartData.maxVal} />
                            </div>
                        )}
                    </div>
                </div>

            </div>
        </div>
    </section>
  );
};

// --- Main App ---
const App = () => {
    const [activeView, setActiveView] = useState('home');
    const handleNavigate = (view) => setActiveView(view);
    
    useEffect(() => {
        if(auth) {
             onAuthStateChanged(auth, (user) => { console.log("Auth:", user ? "OK" : "Anon"); });
             signInAnonymously(auth).catch(e => console.error(e));
        }
    }, []);

    return (
        <div className="font-sans text-slate-900 bg-white">
            <Navbar isScrolled={true} activeView={activeView} onNavigate={handleNavigate} />
            
            {activeView === 'home' && (
                <>
                    <Hero />
                    <ObjectiveSection />
                    <KeyFunctions />
                    <CategoriesSection />
                    <ProcessSection />
                    <TrackingSection />
                    <ContactSection />
                    <Footer />
                </>
            )}
            
            {activeView === 'dashboard' && <DashboardSection onBack={() => handleNavigate('home')} />}
            
            {activeView === 'catalog' && <CatalogRequestSection onBack={() => handleNavigate('home')} />}
            
            {activeView === 'analysis' && <AnalysisLanding onNavigate={handleNavigate} />}
        </div>
    );
};

export default App;
