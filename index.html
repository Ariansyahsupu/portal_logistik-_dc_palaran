<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DC Palaran - Mining Logistics Hub</title>
    
    <!-- Tailwind CSS (Styling) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons (Ikon) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- XLSX Library (Untuk membaca file Excel) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #f97316; }
        .animate-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .bg-clip-text { -webkit-background-clip: text; background-clip: text; }
        html { scroll-behavior: smooth; }
        
        /* Utility Class untuk Field Terkunci */
        .locked-field { @apply bg-slate-100 text-slate-400 cursor-not-allowed border-slate-200 pointer-events-none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 selection:bg-orange-500 selection:text-white">

    <!-- Container Utama Aplikasi -->
    <div id="app-root"></div>

    <!-- Script Utama (Logic Aplikasi) -->
    <script type="module">
        // Import Module Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. Konfigurasi Firebase ---
        let firebaseConfig;
        if (typeof __firebase_config !== 'undefined' && __firebase_config) {
            try { firebaseConfig = JSON.parse(__firebase_config); } catch (e) { console.error(e); }
        }
        if (!firebaseConfig) {
             firebaseConfig = { apiKey: "GANTI_DENGAN_API_KEY_ANDA", authDomain: "PROJECT.firebaseapp.com", projectId: "PROJECT_ID" };
        }

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (error) { console.error("Firebase Init Error:", error); }

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'dc-palaran-app';
        let currentUser = null;

        // --- GLOBAL STATE ---
        let zerpdDataMap = new Map(); 
        let isZerpdUploaded = false; 

        // --- 2. Helper Functions ---
        const formatIDR = (val) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(val);
        
        const parseCSV = (text) => {
             const rows = []; let currentRow = [], currentCell = '', inQuotes = false;
             for (let i = 0; i < text.length; i++) {
                const char = text[i];
                if (char === '"' && text[i+1] === '"') { currentCell += '"'; i++; }
                else if (char === '"') inQuotes = !inQuotes;
                else if (char === ',' && !inQuotes) { currentRow.push(currentCell.trim()); currentCell = ''; }
                else if ((char === '\n' || char === '\r') && !inQuotes) {
                    if (currentCell || currentRow.length) rows.push(currentRow);
                    currentRow = []; currentCell = '';
                } else currentCell += char;
             }
             if (currentCell || currentRow.length) { currentRow.push(currentCell.trim()); rows.push(currentRow); }
             return rows;
        }

        const renderIcons = (retryCount = 0) => {
            if (window.lucide && typeof window.lucide.createIcons === 'function') {
                window.lucide.createIcons();
            } else {
                if (retryCount < 20) setTimeout(() => renderIcons(retryCount + 1), 50);
            }
        };

        const normalizeString = (str) => {
            if (!str) return "";
            return String(str).toUpperCase().replace(/[^A-Z0-9]/g, '');
        };

        // --- 4. State Management ---
        const AppState = { currentView: 'home', navbarScrolled: false, mobileMenuOpen: false };

        // --- 5. View Renderers ---

        function renderNavbar() {
            const bgClass = AppState.navbarScrolled ? 'bg-slate-900 shadow-lg py-3' : 'bg-transparent py-5';
            return `
            <nav class="fixed w-full z-50 transition-all duration-300 ${bgClass}">
              <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center">
                  <div class="flex items-center space-x-2 cursor-pointer" onclick="window.handleNavClick('home')">
                    <div class="bg-orange-500 p-2 rounded-lg"><i data-lucide="anchor" class="h-6 w-6 text-white"></i></div>
                    <div class="flex flex-col"><span class="text-xl font-bold tracking-tighter text-white">DC PALARAN</span><span class="text-xs text-orange-400 font-medium tracking-widest uppercase">Mining Logistics Hub</span></div>
                  </div>
                  <div class="hidden lg:flex items-center space-x-6">
                    <button onclick="window.handleNavClick('home', '#home')" class="text-slate-200 hover:text-orange-500 font-medium text-sm uppercase">Home</button>
                    <button onclick="window.handleNavClick('analysis')" class="text-slate-200 hover:text-orange-500 font-medium text-sm uppercase">Analysis Tools</button>
                    <button onclick="window.handleNavClick('home', '#functions')" class="text-slate-200 hover:text-orange-500 font-medium text-sm uppercase">Functions</button>
                    <button onclick="window.handleNavClick('home', '#process')" class="text-slate-200 hover:text-orange-500 font-medium text-sm uppercase">Process</button>
                    <button onclick="window.handleNavClick('home', '#tracking')" class="text-slate-200 hover:text-orange-500 font-medium text-sm uppercase">Tracking</button>
                    <button onclick="window.handleNavClick('catalog')" class="text-slate-200 hover:text-orange-500 font-medium text-sm uppercase flex items-center"><i data-lucide="file-text" class="w-4 h-4 mr-1"></i> Catalog</button>
                    <button onclick="window.handleNavClick('dashboard')" class="text-slate-200 hover:text-orange-500 font-medium text-sm uppercase flex items-center"><i data-lucide="layout-dashboard" class="w-4 h-4 mr-1"></i> Dashboard</button>
                    <button onclick="window.handleNavClick('home', '#contact')" class="bg-orange-500 hover:bg-orange-600 text-white px-5 py-2 rounded-sm font-bold transition-all text-sm uppercase">Check Stock</button>
                  </div>
                  <div class="lg:hidden"><button onclick="window.toggleMobileMenu()" class="text-white"><i data-lucide="${AppState.mobileMenuOpen ? 'x' : 'menu'}" class="h-8 w-8"></i></button></div>
                </div>
              </div>
              ${AppState.mobileMenuOpen ? `<div class="lg:hidden bg-slate-900 border-t border-slate-800 p-4 space-y-2"><button onclick="window.handleNavClick('home')" class="block text-slate-300 py-2">Home</button><button onclick="window.handleNavClick('analysis')" class="block text-slate-300 py-2">Analysis Tools</button><button onclick="window.handleNavClick('catalog')" class="block text-slate-300 py-2">Catalog</button><button onclick="window.handleNavClick('dashboard')" class="block text-slate-300 py-2">Dashboard</button></div>` : ''}
            </nav>`;
        }

        function renderHero() { 
            return `
            <div id="home" class="relative h-screen flex items-center justify-center overflow-hidden bg-slate-900">
                <div class="absolute inset-0 z-0"><img src="https://images.unsplash.com/photo-1586528116311-ad8dd3c8310d?lib=rb-4.0.3&auto=format&fit=crop&w=2070&q=80" class="w-full h-full object-cover opacity-40"><div class="absolute inset-0 bg-gradient-to-r from-slate-900 via-slate-900/80 to-transparent"></div></div>
                <div class="relative z-10 max-w-7xl mx-auto px-4 flex flex-col justify-center h-full">
                    <div class="max-w-3xl">
                        <div class="inline-flex items-center space-x-2 bg-orange-500/10 border border-orange-500/30 rounded-full px-4 py-1 mb-6 backdrop-blur-sm"><span class="flex h-2 w-2 rounded-full bg-orange-500 animate-pulse"></span><span class="text-orange-400 text-sm font-semibold tracking-wide uppercase">Operational Efficiency Optimized</span></div>
                        <h1 class="text-5xl md:text-7xl font-extrabold text-white leading-tight mb-6">The Central Nerve of <br/><span class="text-transparent bg-clip-text bg-gradient-to-r from-orange-400 to-orange-600">Mining Logistics</span></h1>
                        <p class="text-xl text-slate-300 mb-8 max-w-2xl leading-relaxed">DC Palaran serves as the premier Transit Hub and Buffer Stock Center, ensuring seamless inventory stability.</p>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <button onclick="window.handleNavClick('home', '#functions')" class="px-8 py-4 bg-orange-500 hover:bg-orange-600 text-slate-900 font-bold rounded-sm shadow-lg flex items-center justify-center">Explore Capabilities <i data-lucide="arrow-right" class="ml-2 h-5 w-5"></i></button>
                            <button onclick="window.handleNavClick('dashboard')" class="px-8 py-4 border border-slate-500 bg-slate-800/50 backdrop-blur-md text-white font-bold rounded-sm hover:border-orange-500 hover:text-orange-400 flex items-center justify-center"><i data-lucide="activity" class="mr-2 h-5 w-5"></i> Live Dashboard</button>
                        </div>
                    </div>
                </div>
            </div>`; 
        }

        function renderObjective() { 
            return `
            <section class="py-20 bg-white">
                <div class="max-w-7xl mx-auto px-4 grid grid-cols-1 lg:grid-cols-2 gap-16 items-center">
                    <div>
                        <h2 class="text-orange-500 font-bold uppercase tracking-widest text-sm mb-2">Our Core Mission</h2>
                        <h3 class="text-4xl font-bold text-slate-900 mb-6">Optimizing Inventory Utilization & Stabilization</h3>
                        <p class="text-slate-600 text-lg leading-relaxed mb-6">The primary objective of DC Palaran is to function as the stabilizing force across the entire supply chain. By centralizing the "MIN-MAX" logic, we prevent stockouts at remote sites while minimizing capital tied up in excess inventory.</p>
                        <ul class="space-y-4">
                            ${['Centralized Buffer Stock Management', 'Reduction of Site-Level Deadstock', 'Rapid Deployment to Satellite Projects', 'Cost Efficiency through consolidated logistics'].map(item => `<li class="flex items-center text-slate-700 font-medium"><div class="mr-3 bg-slate-100 p-1 rounded-full text-orange-500"><i data-lucide="shield-check" class="h-5 w-5"></i></div>${item}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="relative">
                        <div class="absolute -inset-4 bg-orange-100 rounded-xl transform rotate-2"></div>
                        <img src="https://images.unsplash.com/photo-1553413077-190dd305871c?ixlib=rb-4.0.3&auto=format&fit=crop&w=1035&q=80" class="relative rounded-lg shadow-2xl w-full object-cover h-96">
                        <div class="absolute bottom-6 left-6 bg-slate-900 p-6 rounded-lg shadow-xl max-w-xs border-l-4 border-orange-500"><p class="text-slate-400 text-sm uppercase font-semibold mb-1">Efficiency Rate</p><div class="flex items-end"><span class="text-4xl font-bold text-white">99.8%</span><span class="text-orange-500 ml-2 mb-1 font-medium">Stock Accuracy</span></div></div>
                    </div>
                </div>
            </section>`; 
        }

        // --- FULL CONTENT RESTORED ---
        function renderKeyFunctions() {
            const funcs = [
                { icon: 'truck', title: "Strategic Transit Hub", desc: "Acting as the primary consolidation point for vendors and the dispatch point for remote sites." },
                { icon: 'database', title: "Buffer Stock Center", desc: "Managing volatility through three core pillars: Part Forecast buffering, Deadstock revitalization, and consolidation." },
                { icon: 'bar-chart-3', title: "Inventory Stabilization", desc: "The control tower for MIN-MAX levels. We monitor consumption rates to dynamically adjust inventory levels." }
            ];
            return `
            <section id="functions" class="py-20 bg-slate-50">
                <div class="max-w-7xl mx-auto px-4 text-center mb-16">
                    <h2 class="text-3xl md:text-4xl font-bold text-slate-900 mb-4">Key Operational Functions</h2>
                    <div class="w-24 h-1 bg-orange-500 mx-auto rounded-full"></div>
                    <p class="mt-4 text-slate-600 max-w-2xl mx-auto">DC Palaran goes beyond simple storage. We are an active logistics engine designed to support high-intensity Mining & Hauling operations.</p>
                </div>
                <div class="max-w-7xl mx-auto px-4 grid grid-cols-1 md:grid-cols-3 gap-8">
                    ${funcs.map(f => `<div class="bg-white rounded-xl shadow-lg p-8 border-t-4 border-transparent hover:border-orange-500 transition-all group"><div class="mb-6 bg-slate-50 w-20 h-20 rounded-full flex items-center justify-center group-hover:bg-orange-50"><i data-lucide="${f.icon}" class="h-10 w-10 text-orange-500"></i></div><h3 class="text-xl font-bold text-slate-900 mb-3">${f.title}</h3><p class="text-slate-600 leading-relaxed">${f.desc}</p></div>`).join('')}
                </div>
            </section>`;
        }

        function renderCategories() {
            const cats = [
                { name: "Spare Parts", icon: "settings", img: "https://images.unsplash.com/photo-1486262715619-67b85e0b08d3?ixlib=rb-4.0.3" },
                { name: "Tyres & Rims", icon: "layers", img: "https://images.unsplash.com/photo-1583258509156-f28822026858?ixlib=rb-4.0.3" },
                { name: "Components", icon: "cpu", img: "https://images.unsplash.com/photo-1580894732930-0babd100d356?ixlib=rb-4.0.3" },
                { name: "General Supplies", icon: "box", img: "https://images.unsplash.com/photo-1595074474855-f9397f8ef5fd?ixlib=rb-4.0.3" }
            ];
            return `
            <section id="categories" class="py-20 bg-slate-900 text-white">
                <div class="max-w-7xl mx-auto px-4 mb-12 flex flex-col md:flex-row justify-between items-end"><div><h2 class="text-3xl font-bold mb-2">Material Categories</h2><p class="text-slate-400">Comprehensive inventory management for diverse operational needs.</p></div></div>
                <div class="max-w-7xl mx-auto px-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    ${cats.map(c => `<div class="group relative h-96 rounded-lg overflow-hidden cursor-pointer"><img src="${c.img}&auto=format&fit=crop&w=600&q=80" class="absolute inset-0 w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"><div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-slate-900/60 to-transparent opacity-90"></div><div class="absolute bottom-0 left-0 p-6 w-full"><div class="bg-orange-500 w-12 h-12 rounded-lg flex items-center justify-center mb-4"><i data-lucide="${c.icon}" class="text-white w-6 h-6"></i></div><h3 class="text-xl font-bold mb-2 border-l-4 border-orange-500 pl-3">${c.name}</h3></div></div>`).join('')}
                </div>
            </section>`;
        }

        function renderProcess() {
            return `
            <section id="process" class="py-20 bg-white">
                <div class="max-w-7xl mx-auto px-4 text-center mb-16"><h2 class="text-3xl font-bold text-slate-900">Operational Process Flow</h2><p class="mt-4 text-slate-600">Strict adherence to quality and accuracy at every stage.</p></div>
                <div class="max-w-7xl mx-auto px-4 relative">
                    <div class="hidden md:block absolute top-1/2 left-0 w-full h-1 bg-slate-200 -translate-y-1/2 z-0"></div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-12 relative z-10">
                        ${['Incoming & QC', 'Inventory Mgmt', 'Outgoing & Dispatch'].map((t,i) => `<div class="bg-white p-6 rounded-xl border border-slate-100 shadow-lg text-center"><div class="w-16 h-16 ${i===1?'bg-orange-500':'bg-slate-900'} text-white rounded-full flex items-center justify-center text-2xl font-bold mx-auto mb-6 ring-8 ring-white">${i+1}</div><h3 class="text-xl font-bold text-slate-800 mb-3">${t}</h3><p class="text-slate-500 text-sm">Critical procedures ensuring operational excellence.</p></div>`).join('')}
                    </div>
                </div>
            </section>`;
        }

        function renderTrackingSection() {
            return `
            <section id="tracking" class="py-20 bg-slate-50 border-b border-slate-200">
                <div class="max-w-7xl mx-auto px-4">
                    <div class="bg-white rounded-2xl shadow-xl overflow-hidden flex flex-col md:flex-row">
                        <div class="md:w-5/12 bg-slate-900 p-10 text-white flex flex-col justify-center">
                            <h2 class="text-3xl font-bold mb-4 flex items-center"><i data-lucide="search" class="mr-3 text-orange-500"></i> Track Shipment</h2>
                            <p class="text-slate-300">Monitor real-time status via STO Number.</p>
                        </div>
                        <div class="md:w-7/12 p-10">
                            <form onsubmit="window.handleTrack(event)" class="mb-8"><label class="block text-sm font-bold text-slate-900 mb-2 uppercase">Enter STO Number</label><div class="flex gap-2"><input id="stoInput" type="text" placeholder="e.g. 450012345" class="flex-1 px-4 py-3 border border-slate-300 rounded-sm focus:ring-2 focus:ring-orange-500 outline-none"><button type="submit" class="bg-orange-500 text-white font-bold px-8 py-3 rounded-sm hover:bg-orange-600">Track</button></div></form>
                            <div id="trackingResult" class="hidden animate-in"></div>
                        </div>
                    </div>
                </div>
            </section>`;
        }

        function renderContact() {
            const plants = [
                {code: "PL01", name: "MSJ"}, {code: "PL03", name: "BE"}, {code: "PL06", name: "KALSEL"}, 
                {code: "PL09", name: "MME"}, {code: "PL14", name: "TJP"}, {code: "PL15", name: "GAM"}, 
                {code: "PL18", name: "ABP"}, {code: "PL19", name: "GSP"}, {code: "PL22", name: "MRW"}
            ];
            
            return `
            <section id="contact" class="py-20 bg-slate-900 text-white">
                <div class="max-w-7xl mx-auto px-4 grid grid-cols-1 md:grid-cols-2 gap-16">
                    <div>
                        <h2 class="text-3xl font-bold mb-6">Contact Control Tower</h2>
                        <p class="text-slate-400 mb-8">We operate 24/7 for critical dispatch requests.</p>
                        <div class="space-y-6">
                            <div class="flex items-start"><i data-lucide="map-pin" class="w-6 h-6 text-orange-500 mr-4"></i><div><h4 class="font-bold">DC Palaran Main Hub</h4><p class="text-slate-400 text-sm">Jl. Trikora, Palaran, Samarinda</p></div></div>
                            <div class="flex items-center"><i data-lucide="phone" class="w-6 h-6 text-orange-500 mr-4"></i><div><h4 class="font-bold">Emergency Hotline</h4><p class="text-slate-400 text-sm">+62 811-555-0123</p></div></div>
                            <div class="flex items-center"><i data-lucide="mail" class="w-6 h-6 text-orange-500 mr-4"></i><div><h4 class="font-bold">Email Support</h4><p class="text-slate-400 text-sm">logistics@dcpalaran.com</p></div></div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg p-8 text-slate-900">
                        <div class="flex items-center mb-6">
                            <div class="bg-green-100 p-2 rounded-full mr-3"><i data-lucide="message-circle" class="w-6 h-6 text-green-600"></i></div>
                            <div>
                                <h3 class="text-2xl font-bold text-slate-900">Quick Stock Check</h3>
                                <p class="text-xs text-slate-500">Direct WhatsApp Inquiry</p>
                            </div>
                        </div>
                        
                        <form onsubmit="window.handleStockCheck(event)" class="space-y-4">
                            <div>
                                <label class="block text-sm font-bold mb-2">Project Site (PL)</label>
                                <select name="site" class="w-full px-4 py-3 bg-slate-100 border-none rounded-sm focus:ring-2 focus:ring-green-500 outline-none">
                                    <option value="" disabled selected>Select Site...</option>
                                    ${plants.map(p => `<option value="${p.name} (${p.code})">${p.name} (${p.code})</option>`).join('')}
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold mb-2">Search By</label>
                                <div class="flex gap-4 mb-2">
                                    <label class="flex items-center space-x-2 cursor-pointer">
                                        <input type="radio" name="type" value="Material Number" checked class="text-green-600 focus:ring-green-500">
                                        <span class="text-sm">Material Number</span>
                                    </label>
                                    <label class="flex items-center space-x-2 cursor-pointer">
                                        <input type="radio" name="type" value="Part Number" class="text-green-600 focus:ring-green-500">
                                        <span class="text-sm">Part Number</span>
                                    </label>
                                </div>
                                <input name="item" type="text" class="w-full px-4 py-3 bg-slate-100 border-none rounded-sm focus:ring-2 focus:ring-green-500 outline-none" placeholder="Enter Number here..." required>
                            </div>
                            
                            <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 rounded-sm hover:bg-green-700 transition-colors flex items-center justify-center">
                                <i data-lucide="send" class="w-4 h-4 mr-2"></i> Check Stock via WhatsApp
                            </button>
                        </form>
                    </div>
                </div>
            </section>`;
        }
        
        function renderFooter() { return `<footer class="bg-slate-950 text-slate-400 py-8 text-center"><p>&copy; 2025 DC Palaran</p></footer>`; }
        
        function renderDashboard() {
            setTimeout(fetchDashboardData, 100);
            return `<div class="min-h-screen pt-24 pb-12 bg-slate-950 text-white animate-in relative overflow-hidden">
                <div class="max-w-7xl mx-auto px-4 relative z-10"><button onclick="window.handleNavClick('home')" class="mb-6 flex items-center text-slate-400 hover:text-orange-400 text-sm font-medium uppercase"><i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i> Back to Home</button>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10"><div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-6 border border-slate-700"><div class="flex justify-between mb-4"><i data-lucide="dollar-sign" class="text-orange-500 w-6 h-6"></i><span class="text-green-400 text-xs font-bold bg-green-500/10 px-2 py-1 rounded-full">Live</span></div><p class="text-slate-400 text-xs font-bold uppercase mb-1">Total Estimated Value</p><h3 id="dash-val" class="text-4xl font-bold text-white">Loading...</h3></div><div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-6 border border-slate-700"><div class="flex justify-between mb-4"><i data-lucide="package" class="text-blue-500 w-6 h-6"></i></div><p class="text-slate-400 text-xs font-bold uppercase mb-1">Total Items Dispatched</p><h3 id="dash-vol" class="text-4xl font-bold text-white">Loading...</h3></div></div>
                </div></div>`;
        }

        // --- CATALOG MODULE ---
        function renderCatalog() {
            const plantOptions = Array.from({length: 28}, (_, i) => `<option value="PL${String(i + 1).padStart(2, '0')}">PL${String(i + 1).padStart(2, '0')}</option>`).join('');
            const storageLocOptions = Array.from({length: 15}, (_, i) => `<option value="S${String(i + 1).padStart(3, '0')}">S${String(i + 1).padStart(3, '0')}</option>`).join('');

            const materialTypes = [
                {code: "SPRT", desc: "Sparepart"}, {code: "FOGC", desc: "FOGC"}, {code: "TIRE", desc: "Tire"},
                {code: "CONS", desc: "Consumable"}, {code: "GENS", desc: "General Supply"}, {code: "ASET", desc: "Asset"},
                {code: "SEJA", desc: "Service & Jasa"}, {code: "MDLE", desc: "Module"}, {code: "BOMM", desc: "Bom Material"},
                {code: "FFF", desc: "Fff Class"}
            ];
            const matTypeOptions = materialTypes.map(t => `<option value="${t.code}">${t.code} - ${t.desc}</option>`).join('');

            const materialGroups = [
                {code: "S001", desc: "Sparepart"}, {code: "S002", desc: "Electrical System"}, {code: "S003", desc: "Transmission"},
                {code: "S004", desc: "Get"}, {code: "S005", desc: "Undercarriage"}, {code: "S006", desc: "Wheel"},
                {code: "F001", desc: "Fuel"}, {code: "F002", desc: "Oil"}, {code: "F003", desc: "Grease"}, {code: "F004", desc: "Coolant"},
                {code: "T001", desc: "Tyre"}, {code: "G001", desc: "General Supply"}, {code: "G002", desc: "APD"},
                {code: "C001", desc: "Rambu-Rambu"}, {code: "C002", desc: "Aksesoris"}, {code: "C003", desc: "Common Tools"},
                {code: "C004", desc: "Medicine"}, {code: "C005", desc: "Alat Tulis Kantor"}, {code: "C006", desc: "Peralatan/perlengkapan"}, {code: "C007", desc: "Beban Seragam"},
                {code: "A001", desc: "Hardware"}, {code: "A002", desc: "Software"}, {code: "A003", desc: "Equipment"},
                {code: "A004", desc: "Building"}, {code: "A005", desc: "Special Tools"}, {code: "A006", desc: "Inventaris"},
                {code: "J001", desc: "Jasa Pengiriman"}, {code: "J002", desc: "Jasa Sertifikasi"}, {code: "J003", desc: "Jasa Survey"},
                {code: "J004", desc: "Jasa Fabrikasi"}, {code: "J005", desc: "Jasa Lab"}, {code: "J006", desc: "Jasa Konsultan"},
                {code: "J007", desc: "Jasa Angkut BBM"}, {code: "J008", desc: "Jasa Blasting"}, {code: "J009", desc: "Jasa Perbaikan bgn"},
                {code: "J010", desc: "Jasa Perbaikan mesin"}, {code: "J011", desc: "Jasa Perbaikan alat berat"}, {code: "J012", desc: "Jasa Perbaikan kendaraan"},
                {code: "J013", desc: "Jasa Perbaikan alat"}, {code: "J014", desc: "Jasa mobilisasi"}, {code: "J015", desc: "Jasa sewa kendaraan"},
                {code: "M001", desc: "Module"}
            ];
            const matGroupOptions = materialGroups.map(g => `<option value="${g.code}">${g.code} - ${g.desc}</option>`).join('');

            const purchasingGroups = [
                {code: "G01", desc: "Sparepart"}, {code: "G02", desc: "Consumable"}, {code: "G03", desc: "Service"}, {code: "G04", desc: "Fuel"}, {code: "G05", desc: "Infrastruktur"}, {code: "G06", desc: "Sarana"}, {code: "G07", desc: "Ast, Mdl"}
            ];
            const purchGroupOptions = purchasingGroups.map(g => `<option value="${g.code}">${g.code} : ${g.desc}</option>`).join('');

            const valClassOptions = [
                {code: "V001", desc: "Sparepart"}, {code: "V002", desc: "Fuel"}, {code: "V003", desc: "Oli"}, {code: "V004", desc: "Grease"}, {code: "V005", desc: "Coolant"}, {code: "V006", desc: "Ban & Velg"},
                {code: "V007", desc: "Biaya perlengkapan safety"}, {code: "V008", desc: "Beban Peralatan"}, {code: "V009", desc: "Pemakaian Tools"}, {code: "V010", desc: "Biaya P3K"}, {code: "V011", desc: "Consumable"},
                {code: "V012", desc: "Beban Pengiriman"}, {code: "V013", desc: "Beban Lab"}, {code: "V014", desc: "Beban Survey"}, {code: "V015", desc: "Beban Perbaikan Mesin"},
                {code: "V016", desc: "Beban Konsultan"}, {code: "V017", desc: "Beban Angkut BBM"}, {code: "V018", desc: "Beban Blasting"}, {code: "V019", desc: "Beban Perbaikan Bangunan"},
                {code: "V020", desc: "Beban Perbaikan Alat Berat"}, {code: "V021", desc: "Beban Perbaikan Kendaraan"}, {code: "V022", desc: "Beban Perbaikan Peralatan"},
                {code: "V023", desc: "Beban Mobilisasi"}, {code: "V024", desc: "Beban ATK"}, {code: "V025", desc: "Beban Seragam"}, {code: "V026", desc: "Js Lab"},
                {code: "V027", desc: "Js Sewa Kendaraan"}, {code: "V028", desc: "Beban Sewa Bangunan"}, {code: "V029", desc: "Beban Sewa Alat Berat"}, {code: "V030", desc: "Bbn Sw Perltn"},
                {code: "V031", desc: "Blasting"}, {code: "V032", desc: "Beban Perijinan"}, {code: "V033", desc: "Asuransi"}, {code: "V034", desc: "By Internet"}, {code: "V035", desc: "Jasa Import"}
            ];
            const valClassOptionsHtml = valClassOptions.map(v => `<option value="${v.code}">${v.code} - ${v.desc}</option>`).join('');

            // Define Lock Class
            const lockedClass = "bg-slate-100 text-slate-400 cursor-not-allowed border-slate-200 master-data-field";

            return `
            <div class="min-h-screen pt-24 pb-12 bg-slate-50 text-slate-900 animate-in">
                <div class="max-w-6xl mx-auto px-4">
                    <button onclick="window.handleNavClick('home')" class="mb-6 flex items-center text-slate-500 hover:text-orange-600 font-medium text-sm"><i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i> Back to Home</button>
                    <div class="bg-white rounded-xl shadow-xl overflow-hidden border border-slate-200">
                        <div class="bg-slate-900 p-8 text-white">
                            <h2 class="text-3xl font-bold mb-2 flex items-center"><i data-lucide="file-text" class="mr-3 text-orange-500"></i> New Material Request</h2>
                            <p class="text-slate-400">Formulir registrasi Master Data Material baru.</p>
                        </div>
                        <div class="p-8">
                            
                            <!-- ZERPD VERIFICATION SECTION -->
                            <div class="bg-orange-50 border border-orange-200 rounded-lg p-6 mb-8">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h4 class="font-bold text-orange-800 mb-2 flex items-center"><i data-lucide="shield-check" class="w-5 h-5 mr-2"></i> Duplicate Check (ZERPD)</h4>
                                        <p class="text-sm text-orange-700 mb-4">Upload file <strong>ZERPD.xlsx</strong> (Nama file: [Tanggal] ZERPD ALL SITE) untuk membuka formulir.</p>
                                    </div>
                                    <button id="deleteZerpdBtn" onclick="window.deleteZerpdFile()" class="hidden text-red-500 hover:text-red-700 flex items-center text-sm font-bold"><i data-lucide="trash-2" class="w-4 h-4 mr-1"></i> Remove File</button>
                                </div>
                                <div class="flex items-center gap-4" id="zerpdUploadContainer">
                                    <input type="file" id="zerpdFile" accept=".xlsx" onchange="window.handleZerpdUpload(this)" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-orange-500 file:text-white hover:file:bg-orange-600"/>
                                </div>
                                <div id="zerpdStatus" class="text-sm font-bold text-slate-400 mt-2">Waiting for file...</div>
                            </div>

                            <form onsubmit="window.handleCatalogSubmit(event)" class="space-y-8">
                                
                                <!-- Requester Info (Always Active) -->
                                <div class="bg-slate-50 p-6 rounded-lg border border-slate-200">
                                    <h4 class="font-bold text-slate-800 mb-4 pb-2 border-b border-slate-300 flex items-center"><i data-lucide="user" class="w-4 h-4 mr-2 text-orange-500"></i> Requester Information</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Requester Name</label><input required name="requester_name" type="text" class="w-full px-3 py-2 border border-slate-300 rounded focus:ring-2 focus:ring-orange-500 outline-none"></div>
                                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Department</label><input required name="department" type="text" class="w-full px-3 py-2 border border-slate-300 rounded focus:ring-2 focus:ring-orange-500 outline-none"></div>
                                    </div>
                                </div>

                                <!-- Manufacturing Part Number Verification (GATEKEEPER) -->
                                <div class="bg-blue-50 p-6 rounded-lg border border-blue-200">
                                     <h4 class="font-bold text-blue-900 mb-4 pb-2 border-b border-blue-300 flex items-center"><i data-lucide="search" class="w-4 h-4 mr-2"></i> Part Number Verification</h4>
                                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div class="relative">
                                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Manufacturing Part Number</label>
                                            <div class="flex gap-2">
                                                <input id="inputMPN" name="manuf_part_number" disabled type="text" class="w-full px-3 py-2 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none bg-slate-100 cursor-not-allowed" placeholder="Upload ZERPD first...">
                                                <button type="button" onclick="window.checkPartNumber()" class="bg-blue-600 text-white px-6 py-2 rounded text-xs font-bold hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" id="btnVerifyMPN" disabled>VERIFY</button>
                                            </div>
                                        </div>
                                        <div class="flex items-center">
                                            <p id="mpnStatus" class="text-sm font-bold ml-2"></p>
                                        </div>
                                        <div class="md:col-span-2 hidden" id="duplicateWarning">
                                             <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded shadow-sm">
                                                <div class="flex items-start">
                                                    <i data-lucide="alert-triangle" class="w-5 h-5 mr-2 mt-0.5"></i>
                                                    <div>
                                                        <p class="font-bold">Mohon pastikan kembali PN dikarenakan PN sdh terdaftar di ZERPD</p>
                                                        <p class="text-sm mt-1">Existing Match: <span id="existingMPNDisplay" class="font-mono bg-red-200 px-1 rounded"></span> (Material: <span id="existingMatDisplay" class="font-mono"></span>)</p>
                                                    </div>
                                                </div>
                                             </div>
                                        </div>
                                     </div>
                                </div>

                                <!-- Group 1: Basic Material Data (LOCKED) -->
                                <div>
                                    <h4 class="font-bold text-slate-800 mb-4 flex items-center"><i data-lucide="box" class="w-4 h-4 mr-2 text-orange-500"></i> 1. Basic Material Data</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div class="md:col-span-3"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Description</label><input required disabled name="description" type="text" class="w-full px-3 py-2 border border-slate-300 rounded outline-none ${lockedClass}" placeholder="Material Description"></div>
                                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Old Material Number</label><input disabled name="old_material_number" type="text" class="w-full px-3 py-2 border border-slate-300 rounded outline-none ${lockedClass}"></div>
                                        
                                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Material Type</label><select disabled name="material_type" class="w-full px-3 py-2 border border-slate-300 rounded outline-none ${lockedClass}"><option value="" disabled selected>Select Type...</option>${matTypeOptions}</select></div>
                                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Base UoM</label><input disabled name="base_uom" type="text" class="w-full px-3 py-2 border border-slate-300 rounded outline-none ${lockedClass}" placeholder="e.g. PC"></div>
                                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Material Group</label><select disabled name="material_group" class="w-full px-3 py-2 border border-slate-300 rounded outline-none ${lockedClass}"><option value="" disabled selected>Select Group...</option>${matGroupOptions}</select></div>
                                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Plant</label><select disabled required name="plant" class="w-full px-3 py-2 border border-slate-300 rounded outline-none ${lockedClass}"><option value="" disabled selected>Select Plant...</option>${plantOptions}</select></div>
                                    </div>
                                </div>

                                <!-- Group 2: Manufacturing & Purchasing (LOCKED) -->
                                <div>
                                    <h4 class="font-bold text-slate-800 mb-4 flex items-center"><i data-lucide="settings" class="w-4 h-4 mr-2 text-orange-500"></i> 2. Manufacturing & Purchasing</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                        <div class="md:col-span-2"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Manuf. Part Profile</label><input disabled name="manuf_profile" type="text" class="w-full px-3 py-2 border border-slate-300 rounded outline-none ${lockedClass}"></div>
                                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Purchasing Group</label><select disabled name="purch_group" class="w-full px-3 py-2 border border-slate-300 rounded outline-none ${lockedClass}"><option value="" disabled selected>Select Group...</option>${purchGroupOptions}</select></div>
                                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Automatic PO</label><select disabled name="auto_po" class="w-full px-3 py-2 border border-slate-300 rounded outline-none ${lockedClass}"><option value="Yes">Yes</option><option value="No">No</option></select></div>
                                    </div>
                                </div>

                                <!-- Group 3: MRP & Planning (LOCKED) -->
                                <div>
                                    <h4 class="font-bold text-slate-800 mb-4 flex items-center"><i data-lucide="bar-chart-2" class="w-4 h-4 mr-2 text-orange-500"></i> 3. MRP & Planning</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">MRP Type</label><input disabled name="mrp_type" type="text" class="w-full px-3 py-2 border border-slate-300 rounded outline-none ${lockedClass}" value="ND"></div>
                                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">MRP Controller</label><input disabled name="mrp_controller" type="text" class="w-full px-3 py-2 border border-slate-300 rounded outline-none ${lockedClass}" value="M01"></div>
                                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Reorder Point</label><input disabled name="reorder_point" type="number" class="w-full px-3 py-2 border border-slate-300 rounded outline-none ${lockedClass}" value="0"></div>
                                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Lot Sizing</label><input disabled name="lot_sizing" type="text" class="w-full px-3 py-2 border border-slate-300 rounded outline-none ${lockedClass}" placeholder="e.g. EX"></div>
                                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Max Stock Level</label><input disabled name="max_stock" type="number" class="w-full px-3 py-2 border border-slate-300 rounded outline-none ${lockedClass}" value="0"></div>
                                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Safety Stock</label><input disabled name="safety_stock" type="number" class="w-full px-3 py-2 border border-slate-300 rounded outline-none ${lockedClass}" value="0"></div>
                                        <div class="md:col-span-2"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Planned Deliv. Time (Days)</label><input disabled name="planned_deliv_time" type="number" class="w-full px-3 py-2 border border-slate-300 rounded outline-none ${lockedClass}" value="28"></div>
                                    </div>
                                </div>

                                <!-- Group 4: Procurement, Valuation & Storage (LOCKED) -->
                                <div>
                                    <h4 class="font-bold text-slate-800 mb-4 flex items-center"><i data-lucide="warehouse" class="w-4 h-4 mr-2 text-orange-500"></i> 4. Procurement, Valuation & Storage</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Procurement Type</label><input disabled name="procurement_type" type="text" class="w-full px-3 py-2 border border-slate-300 rounded outline-none ${lockedClass}" value="F"></div>
                                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Special Procurement</label><input disabled name="special_procure" type="text" class="w-full px-3 py-2 border border-slate-300 rounded outline-none ${lockedClass}" value="40"></div>
                                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Valuation Category</label><input disabled name="valuation_cat" type="text" class="w-full px-3 py-2 border border-slate-300 rounded outline-none ${lockedClass}" value="S"></div>
                                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Valuation Class</label><select disabled name="valuation_class" class="w-full px-3 py-2 border border-slate-300 rounded outline-none ${lockedClass}"><option value="" disabled selected>Select Class...</option>${valClassOptionsHtml}</select></div>
                                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Storage Location</label><select disabled name="storage_loc" class="w-full px-3 py-2 border border-slate-300 rounded outline-none ${lockedClass}"><option value="" disabled selected>Select Loc...</option>${storageLocOptions}</select></div>
                                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Storage Bin</label><input disabled name="storage_bin" type="text" class="w-full px-3 py-2 border border-slate-300 rounded outline-none ${lockedClass}"></div>
                                        <div class="md:col-span-3"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Serial Number Profile</label><input disabled name="serial_profile" type="text" class="w-full px-3 py-2 border border-slate-300 rounded outline-none ${lockedClass}"></div>
                                    </div>
                                </div>

                                <div class="pt-6 border-t border-slate-200">
                                    <button type="submit" id="submitBtn" disabled class="w-full bg-slate-300 text-white font-bold py-4 rounded-md shadow-none flex justify-center items-center text-lg cursor-not-allowed">
                                        <i data-lucide="lock" class="w-5 h-5 mr-2"></i> Verify MPN to Unlock Submit
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function renderAnalysisLanding() {
             return `<div class="min-h-screen pt-24 pb-12 bg-slate-900 text-white animate-in">
                <div class="max-w-7xl mx-auto px-4 text-center mb-12"><h2 class="text-4xl font-extrabold mb-4">Analysis Tools</h2><p class="text-slate-400">Advanced data processing modules.</p></div>
                <div class="max-w-7xl mx-auto px-4 grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div onclick="window.open('https://fff-class.vercel.app/', '_blank')" class="bg-slate-800 rounded-2xl p-8 border border-slate-700 hover:border-orange-500 cursor-pointer group relative overflow-hidden"><div class="absolute top-0 right-0 w-32 h-32 bg-orange-500 opacity-10 rounded-bl-full -mr-8 -mt-8"></div><div class="w-16 h-16 bg-orange-500 rounded-2xl flex items-center justify-center mb-6"><i data-lucide="git-merge" class="text-white w-8 h-8"></i></div><h3 class="text-xl font-bold mb-3">FFF Class Analysis</h3><span class="text-xs font-bold uppercase text-slate-500 group-hover:text-white flex items-center">Launch Tool <i data-lucide="arrow-right" class="ml-2 w-4 h-4"></i></span></div>
                    <div onclick="window.open('https://analisis-pr-oustanding-dc-palaran.vercel.app/', '_blank')" class="bg-slate-800 rounded-2xl p-8 border border-slate-700 hover:border-blue-500 cursor-pointer group relative overflow-hidden"><div class="absolute top-0 right-0 w-32 h-32 bg-blue-600 opacity-10 rounded-bl-full -mr-8 -mt-8"></div><div class="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center mb-6"><i data-lucide="bar-chart-3" class="text-white w-8 h-8"></i></div><h3 class="text-xl font-bold mb-3">PR OS Analysis</h3><span class="text-xs font-bold uppercase text-slate-500 group-hover:text-white flex items-center">Launch Tool <i data-lucide="arrow-right" class="ml-2 w-4 h-4"></i></span></div>
                    <div onclick="window.open('https://block-master-dc-palaran.vercel.app/', '_blank')" class="bg-slate-800 rounded-2xl p-8 border border-slate-700 hover:border-slate-500 cursor-pointer group relative overflow-hidden"><div class="absolute top-0 right-0 w-32 h-32 bg-slate-600 opacity-10 rounded-bl-full -mr-8 -mt-8"></div><div class="w-16 h-16 bg-slate-600 rounded-2xl flex items-center justify-center mb-6"><i data-lucide="alert-triangle" class="text-white w-8 h-8"></i></div><h3 class="text-xl font-bold mb-3">Block Master</h3><span class="text-xs font-bold uppercase text-slate-500 group-hover:text-white flex items-center">Launch Tool <i data-lucide="arrow-right" class="ml-2 w-4 h-4"></i></span></div>
                </div></div>`;
        }

        // --- Event Handlers & Logic ---
        window.handleNavClick = (view, selector = null) => {
            if (AppState.currentView !== view) { AppState.currentView = view; render(); if(selector) setTimeout(() => document.querySelector(selector)?.scrollIntoView({behavior:'smooth'}), 50); else window.scrollTo(0,0); }
            else { if(selector) document.querySelector(selector)?.scrollIntoView({behavior:'smooth'}); else window.scrollTo(0,0); }
            AppState.mobileMenuOpen = false;
        };

        window.fetchDashboardData = async () => { /* Logic Dashboard fetch here */ };

        // ZERPD Logic
        window.handleZerpdUpload = async (input) => {
            const file = input.files[0];
            const statusEl = document.getElementById('zerpdStatus');
            const inputMPN = document.getElementById('inputMPN');
            const btnVerify = document.getElementById('btnVerifyMPN');
            const btnDelete = document.getElementById('deleteZerpdBtn');
            const uploadContainer = document.getElementById('zerpdUploadContainer');
            
            if(!file) return;

            // Date & Name Validation
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const format1 = `${year}${month}${day}`; 
            const format2 = `${day}${month}${year}`; 
            const requiredPhrase = "ZERPD ALL SITE";

            if ((!file.name.includes(format1) && !file.name.includes(format2)) || !file.name.toUpperCase().includes(requiredPhrase)) {
                alert(`Nama file tidak valid!\n\nHarus format: [Tanggal] ${requiredPhrase}\nContoh: ${format2} ${requiredPhrase}.xlsx`);
                input.value = ''; return;
            }

            statusEl.textContent = "Processing ZERPD...";
            statusEl.className = "text-sm font-bold text-orange-600 animate-pulse";

            try {
                const buffer = await file.arrayBuffer();
                const workbook = XLSX.read(new Uint8Array(buffer), { type: 'array' });
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });

                if(jsonData.length < 2) throw new Error("File empty");
                const headers = jsonData[0].map(h => String(h).toLowerCase().replace(/[^a-z0-9]/g, ''));
                let mpnIdx = headers.findIndex(h => h.includes('manufact') && (h.includes('part') || h.includes('no')));
                let matIdx = headers.findIndex(h => h.includes('material') && !h.includes('desc'));
                if(mpnIdx === -1) mpnIdx = 2; 
                if(matIdx === -1) matIdx = 0; 

                zerpdDataMap.clear();
                let count = 0;
                for(let i=1; i<jsonData.length; i++) {
                    const row = jsonData[i];
                    const rawMPN = String(row[mpnIdx] || '').trim();
                    const mat = String(row[matIdx] || '').trim();
                    if(rawMPN && rawMPN.length > 1) {
                        zerpdDataMap.set(normalizeString(rawMPN), { original: rawMPN, material: mat });
                        count++;
                    }
                }
                
                isZerpdUploaded = true;
                statusEl.textContent = `ZERPD Loaded (${count} Records). Input MPN Unlocked.`;
                statusEl.className = "text-sm font-bold text-green-600";
                
                inputMPN.disabled = false;
                inputMPN.classList.remove('bg-slate-100', 'cursor-not-allowed');
                inputMPN.placeholder = "Enter Part Number to Verify";
                btnVerify.disabled = false;
                btnVerify.classList.remove('opacity-50', 'cursor-not-allowed');
                btnDelete.classList.remove('hidden');
                uploadContainer.classList.add('hidden');
            } catch(e) { console.error(e); statusEl.textContent = "Error reading file."; statusEl.className = "text-sm font-bold text-red-600"; input.value = ''; }
        };

        window.deleteZerpdFile = () => {
            if(!confirm("Hapus file ZERPD? Form akan terkunci kembali.")) return;
            zerpdDataMap.clear(); isZerpdUploaded = false; window.lockMasterDataFields();
            
            document.getElementById('inputMPN').disabled = true;
            document.getElementById('inputMPN').value = '';
            document.getElementById('inputMPN').classList.add('bg-slate-100', 'cursor-not-allowed');
            document.getElementById('btnVerifyMPN').disabled = true;
            document.getElementById('btnVerifyMPN').classList.add('opacity-50', 'cursor-not-allowed');
            document.getElementById('deleteZerpdBtn').classList.add('hidden');
            document.getElementById('zerpdUploadContainer').classList.remove('hidden');
            document.getElementById('zerpdFile').value = '';
            document.getElementById('zerpdStatus').textContent = "Waiting for file...";
            document.getElementById('zerpdStatus').className = "text-sm font-bold text-slate-400";
            document.getElementById('duplicateWarning').classList.add('hidden');
            document.getElementById('mpnStatus').textContent = '';
        };

        window.checkPartNumber = () => {
            const input = document.getElementById('inputMPN');
            const status = document.getElementById('mpnStatus');
            const warningBox = document.getElementById('duplicateWarning');
            const normVal = normalizeString(input.value.trim());

            if(!normVal) { status.textContent = "Enter Part Number"; return; }

            if(zerpdDataMap.has(normVal)) {
                const data = zerpdDataMap.get(normVal);
                status.textContent = " DUPLICATE FOUND"; status.className = "text-sm font-bold ml-2 text-red-600";
                document.getElementById('existingMPNDisplay').textContent = data.original;
                document.getElementById('existingMatDisplay').textContent = data.material;
                warningBox.classList.remove('hidden');
                window.lockMasterDataFields();
            } else {
                status.textContent = " AVAILABLE"; status.className = "text-sm font-bold ml-2 text-green-600";
                warningBox.classList.add('hidden');
                window.unlockMasterDataFields();
            }
            lucide.createIcons();
        };

        window.lockMasterDataFields = () => {
            const fields = document.querySelectorAll('.master-data-field');
            const submitBtn = document.getElementById('submitBtn');
            fields.forEach(f => { f.disabled = true; f.classList.add('bg-slate-100', 'cursor-not-allowed', 'text-slate-400'); f.classList.remove('bg-white', 'text-slate-900'); });
            if(submitBtn) { submitBtn.disabled = true; submitBtn.classList.remove('bg-orange-500', 'hover:bg-orange-600', 'text-white', 'shadow-lg'); submitBtn.classList.add('bg-slate-300', 'text-white', 'cursor-not-allowed', 'shadow-none'); submitBtn.innerHTML = `<i data-lucide="lock" class="w-5 h-5 mr-2"></i> Verify MPN to Unlock Submit`; }
        };

        window.unlockMasterDataFields = () => {
            const fields = document.querySelectorAll('.master-data-field');
            const submitBtn = document.getElementById('submitBtn');
            fields.forEach(f => { f.disabled = false; f.classList.remove('bg-slate-100', 'cursor-not-allowed', 'text-slate-400'); f.classList.add('bg-white', 'text-slate-900'); });
            if(submitBtn) { submitBtn.disabled = false; submitBtn.classList.add('bg-orange-500', 'hover:bg-orange-600', 'text-white', 'shadow-lg'); submitBtn.classList.remove('bg-slate-300', 'cursor-not-allowed', 'shadow-none'); submitBtn.innerHTML = `<i data-lucide="send" class="w-5 h-5 mr-2"></i> Submit Master Data Request`; }
            lucide.createIcons();
        };
        
        window.handleCatalogSubmit = async (e) => {
            e.preventDefault(); const form = e.target;
            if(!auth.currentUser) { try { await signInAnonymously(auth); } catch(err) { alert("Auth failed"); return; } }
            // Collect data...
            alert("Submitted!"); form.reset();
        };

        window.handleTrack = async (e) => {
            e.preventDefault(); 
            const input = document.getElementById('stoInput').value.trim(); 
            const container = document.getElementById('trackingResult');
            
            if(!input) return;
            
            container.innerHTML = '<div class="text-center p-4 text-slate-500 flex justify-center"><i data-lucide="loader-2" class="animate-spin mr-2"></i> Searching...</div>'; 
            container.classList.remove('hidden');
            renderIcons();
            
            try {
                const res = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vTPtHu0LJ4f9BZ_7zx4PFIgKShRcuFbl449_tVUbh6c0VKdTZvIM9KrfT7rp_ByEQXEr65OA4hN18Wk/pub?gid=0&single=true&output=csv');
                const rows = parseCSV(await res.text()); 
                const found = rows.find(r => r[6] === input);
                
                if(found) {
                    const rawStatus = (found[33] || '').toUpperCase(); 
                    const project = found[35] || 'Unknown';
                    let activeIndex = 0;
                    
                    if (rawStatus.includes('WAITING') || rawStatus.includes('PACKING')) activeIndex = 1;
                    else if (rawStatus.includes('TERKIRIM') || rawStatus.includes('DISPATCH')) activeIndex = 2;
                    else if (rawStatus.includes('DELIVERED') || rawStatus.includes('SAMPAI')) activeIndex = 3;

                    const steps = [
                        { title: 'Order Confirmed', sub: 'STO Verified', icon: 'check-circle' },
                        { title: 'Picking & Packing', sub: 'Warehouse Processing', icon: 'package' },
                        { title: 'Dispatched', sub: 'Handed to Transporter', icon: 'truck' },
                        { title: 'Delivered', sub: 'Received at Site', icon: 'map-pin' }
                    ];

                    let html = `<div class="bg-slate-50 border border-slate-200 rounded-lg p-4 mb-6 flex justify-between items-center"><div><div class="text-xs text-slate-500 uppercase font-bold">Project</div><div class="text-lg font-bold text-slate-900">${project}</div></div><div class="text-right"><div class="text-xs text-slate-500 uppercase font-bold">Status</div><div class="text-sm font-bold text-orange-600">${rawStatus || 'CONFIRMED'}</div></div></div>`;
                    html += `<div class="space-y-8 relative pl-2 mt-8"><div class="absolute left-6 top-2 bottom-4 w-0.5 bg-slate-200 -z-10"></div>`;
                    
                    steps.forEach((step, idx) => {
                        const isActive = idx <= activeIndex; 
                        const isCurrent = idx === activeIndex;
                        let color = 'bg-slate-200 text-slate-400';
                        
                        if (isActive) {
                            if (idx === 0) color = 'bg-red-600 text-white shadow-lg shadow-red-200';      
                            else if (idx === 1) color = 'bg-yellow-500 text-white shadow-lg shadow-yellow-200'; 
                            else if (idx === 2) color = 'bg-lime-500 text-white shadow-lg shadow-lime-200';     
                            else if (idx === 3) color = 'bg-green-700 text-white shadow-lg shadow-green-200';   
                        }
                        
                        html += `<div class="relative flex items-start group ${isActive ? '' : 'opacity-50'}"><div class="w-8 h-8 rounded-full flex items-center justify-center relative z-10 transition-all ${color} ${isCurrent ? 'scale-110 ring-4 ring-white shadow-lg' : ''}"><i data-lucide="${step.icon}" class="w-4 h-4"></i></div><div class="ml-6 pt-1"><h4 class="font-bold text-slate-900">${step.title}</h4><p class="text-xs text-slate-500">${step.sub}</p></div></div>`;
                    });
                    
                    html += `</div>`; 
                    container.innerHTML = html; 
                    renderIcons();
                } else { 
                    container.innerHTML = `<div class="text-red-500 p-4 font-bold text-center">STO Not Found</div>`; 
                }
            } catch(err) { 
                container.innerHTML = `<div class="text-red-500 p-4">Connection Error</div>`; 
                console.error(err);
            }
        };

        window.handleStockCheck = (e) => {
            e.preventDefault();
            const form = e.target;
            const site = form.site.value;
            const type = form.type.value;
            const item = form.item.value;
            
            if(!site) return alert("Silakan pilih Project Site (PL) terlebih dahulu.");
            
            const message = `Halo Admin DC Palaran, saya ingin cek stock:\n\nSite: ${site}\nItem (${type}): ${item}\n\nMohon informasinya. Terima kasih.`;
            const url = `https://wa.me/628115550123?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
        };

        // Render Logic
        function render() {
            const root = document.getElementById('app-root');
            root.innerHTML = '';
            root.insertAdjacentHTML('beforeend', renderNavbar());

            if (AppState.currentView === 'home') {
                root.insertAdjacentHTML('beforeend', renderHero());
                root.insertAdjacentHTML('beforeend', renderObjective());
                root.insertAdjacentHTML('beforeend', renderKeyFunctions());
                root.insertAdjacentHTML('beforeend', renderCategories());
                root.insertAdjacentHTML('beforeend', renderProcess());
                root.insertAdjacentHTML('beforeend', renderTrackingSection());
                root.insertAdjacentHTML('beforeend', renderContact());
                root.insertAdjacentHTML('beforeend', renderFooter());
            } else if (AppState.currentView === 'dashboard') {
                root.insertAdjacentHTML('beforeend', renderDashboard());
            } else if (AppState.currentView === 'catalog') {
                root.insertAdjacentHTML('beforeend', renderCatalog());
            } else if (AppState.currentView === 'analysis') {
                root.insertAdjacentHTML('beforeend', renderAnalysisLanding());
            }
            renderIcons();

            // Re-init Catalog State
            if (AppState.currentView === 'catalog' && isZerpdUploaded) {
               document.getElementById('inputMPN').disabled = false;
               document.getElementById('inputMPN').classList.remove('bg-slate-100', 'cursor-not-allowed');
               document.getElementById('btnVerifyMPN').disabled = false;
               document.getElementById('btnVerifyMPN').classList.remove('opacity-50', 'cursor-not-allowed');
               document.getElementById('deleteZerpdBtn').classList.remove('hidden');
               document.getElementById('zerpdStatus').textContent = "ZERPD File Loaded. Ready.";
               document.getElementById('zerpdStatus').className = "text-sm font-bold text-green-600";
               document.getElementById('zerpdUploadContainer').classList.add('hidden');
            }
        }

        window.toggleMobileMenu = () => { AppState.mobileMenuOpen = !AppState.mobileMenuOpen; render(); };
        window.addEventListener('scroll', () => { const scrolled = window.scrollY > 50; if(AppState.navbarScrolled !== scrolled) { AppState.navbarScrolled = scrolled; render(); } });

        if(auth) { onAuthStateChanged(auth, (user) => { currentUser = user; }); signInAnonymously(auth).catch(e => console.error(e)); }
        render();

    </script>
</body>
</html>
